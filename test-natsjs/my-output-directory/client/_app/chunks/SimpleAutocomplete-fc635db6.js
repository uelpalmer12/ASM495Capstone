var bn=Object.defineProperty;var pn=(s,e,t)=>e in s?bn(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var l=(s,e,t)=>(pn(s,typeof e!="symbol"?e+"":e,t),t);import{S as wn,i as yn,s as kn,l as B,g as F,r as L,G as tt,H as st,I as it,p as G,o as Ke,q as Je,R as es,d as I,e as K,t as ue,c as J,a as X,h as he,b as P,J as j,T as Z,n as Sn,k as ge,m as _e,U as Ge,V as Ls,W as Ii,F as nt,X as In,j as ke,O as js,Y as vn,Z as vi,_ as Pi}from"./index-5cfe7503.js";const pe=new Uint8Array(0);var Ce;(function(s){s.Disconnect="disconnect",s.Reconnect="reconnect",s.Update="update",s.LDM="ldm",s.Error="error"})(Ce||(Ce={}));var et;(function(s){s.Reconnecting="reconnecting",s.PingTimer="pingTimer",s.StaleConnection="staleConnection"})(et||(et={}));const Jt="127.0.0.1",Oi=2*1e3,Ai=2*60*1e3,Pn=2;var Us;(function(s){s.API="api_audit",s.StreamAction="stream_action",s.ConsumerAction="consumer_action",s.SnapshotCreate="snapshot_create",s.SnapshotComplete="snapshot_complete",s.RestoreCreate="restore_create",s.RestoreComplete="restore_complete",s.MaxDeliver="max_deliver",s.Terminated="terminated",s.Ack="consumer_ack",s.StreamLeaderElected="stream_leader_elected",s.StreamQuorumLost="stream_quorum_lost",s.ConsumerLeaderElected="consumer_leader_elected",s.ConsumerQuorumLost="consumer_quorum_lost"})(Us||(Us={}));var Vt;(function(s){s.Limits="limits",s.Interest="interest",s.Workqueue="workqueue"})(Vt||(Vt={}));var Wt;(function(s){s.Old="old",s.New="new"})(Wt||(Wt={}));var Xt;(function(s){s.File="file",s.Memory="memory"})(Xt||(Xt={}));var ee;(function(s){s.All="all",s.Last="last",s.New="new",s.StartSequence="by_start_sequence",s.StartTime="by_start_time",s.LastPerSubject="last_per_subject"})(ee||(ee={}));var D;(function(s){s.None="none",s.All="all",s.Explicit="explicit",s.NotSet=""})(D||(D={}));var Ve;(function(s){s.Instant="instant",s.Original="original"})(Ve||(Ve={}));var Fe;(function(s){s.StreamSourceHdr="Nats-Stream-Source",s.LastConsumerSeqHdr="Nats-Last-Consumer",s.LastStreamSeqHdr="Nats-Last-Stream",s.ConsumerStalledHdr="Nats-Consumer-Stalled",s.MessageSizeHdr="Nats-Msg-Size",s.RollupHdr="Nats-Rollup",s.RollupValueSubject="sub",s.RollupValueAll="all"})(Fe||(Fe={}));var g;(function(s){s.ApiError="BAD API",s.BadAuthentication="BAD_AUTHENTICATION",s.BadCreds="BAD_CREDS",s.BadHeader="BAD_HEADER",s.BadJson="BAD_JSON",s.BadPayload="BAD_PAYLOAD",s.BadSubject="BAD_SUBJECT",s.Cancelled="CANCELLED",s.ConnectionClosed="CONNECTION_CLOSED",s.ConnectionDraining="CONNECTION_DRAINING",s.ConnectionRefused="CONNECTION_REFUSED",s.ConnectionTimeout="CONNECTION_TIMEOUT",s.Disconnect="DISCONNECT",s.InvalidOption="INVALID_OPTION",s.InvalidPayload="INVALID_PAYLOAD",s.MaxPayloadExceeded="MAX_PAYLOAD_EXCEEDED",s.NoResponders="503",s.NotFunction="NOT_FUNC",s.RequestError="REQUEST_ERROR",s.ServerOptionNotAvailable="SERVER_OPT_NA",s.SubClosed="SUB_CLOSED",s.SubDraining="SUB_DRAINING",s.Timeout="TIMEOUT",s.Tls="TLS",s.Unknown="UNKNOWN_ERROR",s.WssRequired="WSS_REQUIRED",s.JetStreamInvalidAck="JESTREAM_INVALID_ACK",s.JetStream404NoMessages="404",s.JetStream408RequestTimeout="408",s.JetStream409MaxAckPendingExceeded="409",s.JetStreamNotEnabled="503",s.AuthorizationViolation="AUTHORIZATION_VIOLATION",s.AuthenticationExpired="AUTHENTICATION_EXPIRED",s.ProtocolError="NATS_PROTOCOL_ERR",s.PermissionsViolation="PERMISSIONS_VIOLATION"})(g||(g={}));class Ci{constructor(){l(this,"messages");this.messages=new Map,this.messages.set(g.InvalidPayload,"Invalid payload type - payloads can be 'binary', 'string', or 'json'"),this.messages.set(g.BadJson,"Bad JSON"),this.messages.set(g.WssRequired,"TLS is required, therefore a secure websocket connection is also required")}static getMessage(e){return On.getMessage(e)}getMessage(e){return this.messages.get(e)||e}}const On=new Ci;function An(s){return typeof s.code=="string"}class p extends Error{constructor(t,i,n){super(t);l(this,"name");l(this,"message");l(this,"code");l(this,"chainedError");l(this,"api_error");this.name="NatsError",this.message=t,this.code=i,this.chainedError=n}static errorForCode(t,i){const n=Ci.getMessage(t);return new p(n,t,i)}isAuthError(){return this.code===g.AuthenticationExpired||this.code===g.AuthorizationViolation}isPermissionError(){return this.code===g.PermissionsViolation}isProtocolError(){return this.code===g.ProtocolError}isJetStreamError(){return this.api_error!==void 0}jsError(){return this.api_error?this.api_error:null}}function ze(s){return Ei("durable",s)}function $(s){return Ei("stream",s)}function Ei(s,e=""){if(e==="")throw Error(`${s} name required`);[".","*",">"].forEach(i=>{if(e.indexOf(i)!==-1)throw Error(`invalid ${s} name - ${s} name cannot contain '${i}'`)})}function Cn(s,e={}){return Object.assign({name:s,deliver_policy:ee.All,ack_policy:D.Explicit,ack_wait:te(30*1e3),replay_policy:Ve.Instant},e)}function te(s){return s*1e6}function En(s){return s/1e6}function Yt(s){const e=s.headers;return e?e.code>=100&&e.code<200:!1}function Nn(s){var e;return Yt(s)&&((e=s.headers)==null?void 0:e.description)==="Idle Heartbeat"}function kt(s){const e=s.headers;return e?Ni(e.code,e.status):null}function Ni(s,e=""){if(s<300)return null;switch(e=e.toLowerCase(),s){case 408:return p.errorForCode(g.JetStream408RequestTimeout,new Error(e));case 503:return p.errorForCode(g.JetStreamNotEnabled,new Error(e));default:return e===""&&(e=g.Unknown),new p(e,`${s}`)}}const Xe=new TextEncoder,fe=new TextDecoder;function Fn(...s){let e=0;for(let n=0;n<s.length;n++)e+=s[n].length;const t=new Uint8Array(e);let i=0;for(let n=0;n<s.length;n++)t.set(s[n],i),i+=s[n].length;return t}function Ze(...s){const e=[];for(let t=0;t<s.length;t++)e.push(Xe.encode(s[t]));return e.length===0?pe:e.length===1?e[0]:Fn(...e)}function Bs(s){return!s||s.length===0?"":fe.decode(s)}class At{constructor(){l(this,"buffers");l(this,"byteLength");this.buffers=[],this.byteLength=0}static concat(...e){let t=0;for(let r=0;r<e.length;r++)t+=e[r].length;const i=new Uint8Array(t);let n=0;for(let r=0;r<e.length;r++)i.set(e[r],n),n+=e[r].length;return i}static fromAscii(e){return e||(e=""),Xe.encode(e)}static toAscii(e){return fe.decode(e)}reset(){this.buffers.length=0,this.byteLength=0}pack(){if(this.buffers.length>1){const e=new Uint8Array(this.byteLength);let t=0;for(let i=0;i<this.buffers.length;i++)e.set(this.buffers[i],t),t+=this.buffers[i].length;this.buffers.length=0,this.buffers.push(e)}}drain(e){if(this.buffers.length){this.pack();const t=this.buffers.pop();if(t){const i=this.byteLength;(e===void 0||e>i)&&(e=i);const n=t.subarray(0,e);return i>e&&this.buffers.push(t.subarray(e)),this.byteLength=i-e,n}}return new Uint8Array(0)}fill(e,...t){e&&(this.buffers.push(e),this.byteLength+=e.length);for(let i=0;i<t.length;i++)t[i]&&t[i].length&&(this.buffers.push(t[i]),this.byteLength+=t[i].length)}peek(){return this.buffers.length?(this.pack(),this.buffers[0]):new Uint8Array(0)}size(){return this.byteLength}length(){return this.buffers.length}}const Ae=`\r
`,St=At.fromAscii(Ae),Mn=new Uint8Array(St)[0],Tn=new Uint8Array(St)[1];function Rn(s){return s instanceof Uint8Array}function qn(s){for(let e=0;e<s.length;e++){const t=e+1;if(s.byteLength>t&&s[e]===Mn&&s[t]===Tn)return t+1}return 0}function Ln(s){const e=qn(s);if(e>0){const i=new Uint8Array(s).slice(0,e);return fe.decode(i)}return""}function rt(s,...e){for(let t=0;t<e.length;t++){const i=e[t];Object.keys(i).forEach(function(n){s[n]=i[n]})}return s}function gt(s){const e="\u240D",t="\u240A";return fe.decode(s).replace(/\n/g,t).replace(/\r/g,e)}function Ct(s){const e=p.errorForCode(g.Timeout);let t,i;const n=new Promise((r,o)=>{t={cancel:()=>{i&&clearTimeout(i)}},i=setTimeout(()=>{o(e)},s)});return Object.assign(n,t)}function Fi(s=0){return new Promise(e=>{setTimeout(()=>{e()},s)})}function z(){let s={};const e=new Promise((t,i)=>{s={resolve:t,reject:i}});return Object.assign(e,s)}function Mi(s){for(let e=s.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[s[e],s[t]]=[s[t],s[e]]}return s}class be{constructor(){l(this,"inflight");l(this,"processed");l(this,"received");l(this,"noIterator");l(this,"iterClosed");l(this,"done");l(this,"signal");l(this,"yields");l(this,"filtered");l(this,"pendingFiltered");l(this,"ingestionFilterFn");l(this,"protocolFilterFn");l(this,"dispatchedFn");l(this,"ctx");l(this,"_data");l(this,"err");this.inflight=0,this.filtered=0,this.pendingFiltered=0,this.processed=0,this.received=0,this.noIterator=!1,this.done=!1,this.signal=z(),this.yields=[],this.iterClosed=z()}[Symbol.asyncIterator](){return this.iterate()}push(e){if(this.done)return;const{ingest:t,protocol:i}=this.ingestionFilterFn?this.ingestionFilterFn(e,this.ctx||this):{ingest:!0,protocol:!1};t&&(i&&(this.filtered++,this.pendingFiltered++),this.yields.push(e),this.signal.resolve())}async*iterate(){if(this.noIterator)throw new p("unsupported iterator",g.ApiError);try{for(;;){if(this.yields.length===0&&await this.signal,this.err)throw this.err;const e=this.yields;this.inflight=e.length,this.yields=[];for(let t=0;t<e.length;t++)(this.protocolFilterFn?this.protocolFilterFn(e[t]):!0)?(this.processed++,yield e[t],this.dispatchedFn&&e[t]&&this.dispatchedFn(e[t])):this.pendingFiltered--,this.inflight--;if(this.done)break;this.yields.length===0&&(e.length=0,this.yields=e,this.signal=z())}}finally{this.stop()}}stop(e){this.done||(this.err=e,this.done=!0,this.signal.resolve(),this.iterClosed.resolve())}getProcessed(){return this.noIterator?this.received:this.processed}getPending(){return this.yields.length+this.inflight-this.pendingFiltered}getReceived(){return this.received-this.filtered}}function xs(s){let i=!0;const n=new Array(s.length);for(let r=0;r<s.length;r++){let o=s.charCodeAt(r);if(o===58||o<33||o>126)throw new p(`'${s[r]}' is not a valid character for a header key`,g.BadHeader);i&&97<=o&&o<=122?o-=32:!i&&65<=o&&o<=90&&(o+=32),n[r]=o,i=o==45}return String.fromCharCode(...n)}function It(){return new We}const Dt="NATS/1.0";var ie;(function(s){s[s.Exact=0]="Exact",s[s.CanonicalMIME=1]="CanonicalMIME",s[s.IgnoreCase=2]="IgnoreCase"})(ie||(ie={}));class We{constructor(){l(this,"code");l(this,"headers");l(this,"description");this.code=0,this.headers=new Map,this.description=""}[Symbol.iterator](){return this.headers.entries()}size(){return this.headers.size}equals(e){if(e&&this.headers.size===e.headers.size&&this.code===e.code){for(const[t,i]of this.headers){const n=e.values(t);if(i.length!==n.length)return!1;const r=[...i].sort(),o=[...n].sort();for(let c=0;c<r.length;c++)if(r[c]!==o[c])return!1}return!0}return!1}static decode(e){const t=new We,n=fe.decode(e).split(`\r
`),r=n[0];if(r!==Dt){let o=r.replace(Dt,"");t.code=parseInt(o,10);const c=t.code.toString();o=o.replace(c,""),t.description=o.trim()}return n.length>=1&&n.slice(1).map(o=>{if(o){const c=o.indexOf(":");if(c>-1){const u=o.slice(0,c),h=o.slice(c+1).trim();t.append(u,h)}}}),t}toString(){if(this.headers.size===0)return"";let e=Dt;for(const[t,i]of this.headers)for(let n=0;n<i.length;n++)e=`${e}\r
${t}: ${i[n]}`;return`${e}\r
\r
`}encode(){return Xe.encode(this.toString())}static validHeaderValue(e){if(/[\r\n]/.test(e))throw new p("invalid header value - \\r and \\n are not allowed.",g.BadHeader);return e.trim()}keys(){const e=[];for(const t of this.headers.keys())e.push(t);return e}findKeys(e,t=ie.Exact){const i=this.keys();switch(t){case ie.Exact:return i.filter(n=>n===e);case ie.CanonicalMIME:return e=xs(e),i.filter(n=>n===e);default:{const n=e.toLowerCase();return i.filter(r=>n===r.toLowerCase())}}}get(e,t=ie.Exact){const i=this.findKeys(e,t);if(i.length){const n=this.headers.get(i[0]);if(n)return Array.isArray(n)?n[0]:n}return""}has(e,t=ie.Exact){return this.findKeys(e,t).length>0}set(e,t,i=ie.Exact){this.delete(e,i),this.append(e,t,i)}append(e,t,i=ie.Exact){const n=xs(e);i===ie.CanonicalMIME&&(e=n);const r=this.findKeys(e,i);e=r.length>0?r[0]:e;const o=We.validHeaderValue(t);let c=this.headers.get(e);c||(c=[],this.headers.set(e,c)),c.push(o)}values(e,t=ie.Exact){const i=[];return this.findKeys(e,t).forEach(r=>{const o=this.headers.get(r);o&&i.push(...o)}),i}delete(e,t=ie.Exact){this.findKeys(e,t).forEach(n=>{this.headers.delete(n)})}get hasError(){return this.code>=300}get status(){return`${this.code} ${this.description}`.trim()}}function jn(){return{encode(s){return Xe.encode(s)},decode(s){return fe.decode(s)}}}function Ti(s){return{encode(e){try{return e===void 0&&(e=null),Xe.encode(JSON.stringify(e))}catch(t){throw p.errorForCode(g.BadJson,t)}},decode(e){try{return JSON.parse(fe.decode(e),s)}catch(t){throw p.errorForCode(g.BadJson,t)}}}}const Un="$JS.API";function Bn(s){return s=s||{},s.domain&&(s.apiPrefix=`$JS.${s.domain}.API`,delete s.domain),rt({apiPrefix:Un,timeout:5e3},s)}class Et{constructor(e,t){l(this,"nc");l(this,"opts");l(this,"prefix");l(this,"timeout");l(this,"jc");this.nc=e,this.opts=Bn(t),this._parseOpts(),this.prefix=this.opts.apiPrefix,this.timeout=this.opts.timeout,this.jc=Ti()}_parseOpts(){let e=this.opts.apiPrefix;if(!e||e.length===0)throw new Error("invalid empty prefix");e[e.length-1]==="."&&(e=e.substr(0,e.length-1)),this.opts.apiPrefix=e}async _request(e,t=null,i){i=i||{},i.timeout=this.timeout;let n=pe;t&&(n=this.jc.encode(t));const r=await this.nc.request(e,n,i);return this.parseJsResponse(r)}async findStream(e){const t={subject:e},n=await this._request(`${this.prefix}.STREAM.NAMES`,t);if(!n.streams||n.streams.length!==1)throw new Error("no stream matches subject");return n.streams[0]}parseJsResponse(e){const t=this.jc.decode(e.data),i=t;if(i.error){const n=Ni(i.error.code,i.error.description);if(n!==null)throw n.api_error=i.error,n}return t}}class Ri{constructor(e,t,i){l(this,"err");l(this,"offset");l(this,"pageInfo");l(this,"subject");l(this,"jsm");l(this,"filter");if(!e)throw new Error("subject is required");this.subject=e,this.jsm=i,this.offset=0,this.pageInfo={},this.filter=t}async next(){if(this.err)return[];if(this.pageInfo&&this.offset>=this.pageInfo.total)return[];const e={offset:this.offset};try{const t=await this.jsm._request(this.subject,e,{timeout:this.jsm.timeout});this.pageInfo=t;const i=this.filter(t);return this.offset+=i.length,i}catch(t){throw this.err=t,t}}async*[Symbol.asyncIterator](){let e=await this.next();for(;e.length>0;){for(const t of e)yield t;e=await this.next()}}}class qi extends Et{constructor(e,t){super(e,t)}async add(e,t){if($(e),t.deliver_group&&t.flow_control)throw new Error("jetstream flow control is not supported with queue groups");if(t.deliver_group&&t.idle_heartbeat)throw new Error("jetstream idle heartbeat is not supported with queue groups");const i={};i.config=t,i.stream_name=e,i.config.durable_name&&ze(i.config.durable_name);const n=t.durable_name?`${this.prefix}.CONSUMER.DURABLE.CREATE.${e}.${t.durable_name}`:`${this.prefix}.CONSUMER.CREATE.${e}`;return await this._request(n,i)}async update(e,t,i){const n=await this.info(e,t),r=i;return this.add(e,Object.assign(n.config,r))}async info(e,t){return $(e),ze(t),await this._request(`${this.prefix}.CONSUMER.INFO.${e}.${t}`)}async delete(e,t){return $(e),ze(t),(await this._request(`${this.prefix}.CONSUMER.DELETE.${e}.${t}`)).success}list(e){$(e);const t=n=>n.consumers,i=`${this.prefix}.CONSUMER.LIST.${e}`;return new Ri(i,t,this)}}const Ds="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",Gs=36,xn=0xcfd41b9100000,zs=33,Dn=333,Hs=12+10,Gn=zn();function zn(){let s=null;return typeof globalThis!="undefined"&&"crypto"in globalThis&&globalThis.crypto.getRandomValues&&(s=globalThis.crypto),s||(s={getRandomValues:function(e){for(let t=0;t<e.length;t++)e[t]=Math.floor(Math.random()*255)}}),s}class Hn{constructor(){l(this,"buf");l(this,"seq");l(this,"inc");this.buf=new Uint8Array(Hs),this.init()}init(){this.setPre(),this.initSeqAndInc(),this.fillSeq()}initSeqAndInc(){this.seq=Math.floor(Math.random()*xn),this.inc=Math.floor(Math.random()*(Dn-zs)+zs)}setPre(){const e=new Uint8Array(12);Gn.getRandomValues(e);for(let t=0;t<12;t++){const i=e[t]%36;this.buf[t]=Ds.charCodeAt(i)}}fillSeq(){let e=this.seq;for(let t=Hs-1;t>=12;t--)this.buf[t]=Ds.charCodeAt(e%Gs),e=Math.floor(e/Gs)}next(){return this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),String.fromCharCode.apply(String,this.buf)}reset(){this.init()}}const Li=new Hn;class ji{constructor(e,t={timeout:1e3}){l(this,"token");l(this,"received");l(this,"deferred");l(this,"timer");l(this,"ctx");l(this,"mux");this.mux=e,this.received=0,this.deferred=z(),this.token=Li.next(),rt(this,t),this.timer=Ct(t.timeout),this.ctx=new Error}resolver(e,t){this.timer&&this.timer.cancel(),e?(e.stack+=`

${this.ctx.stack}`,this.deferred.reject(e)):this.deferred.resolve(t),this.cancel()}cancel(e){this.timer&&this.timer.cancel(),this.mux.cancel(this),this.deferred.reject(e||p.errorForCode(g.Cancelled))}}const Ks=Uint8Array.of(43,65,67,75),Kn=Uint8Array.of(45,78,65,75),Qe=Uint8Array.of(43,87,80,73),Js=Uint8Array.of(43,78,88,84),Jn=Uint8Array.of(43,84,69,82,77),Vn=Uint8Array.of(32);function vt(s){return new Xn(s)}function Wn(s){const e=s.split(".");if(e.length===9&&e.splice(2,0,"_",""),e.length<11||e[0]!=="$JS"||e[1]!=="ACK")throw new Error("not js message");const t={};return t.domain=e[2]==="_"?"":e[2],t.account_hash=e[3],t.stream=e[4],t.consumer=e[5],t.redeliveryCount=parseInt(e[6],10),t.redelivered=t.redeliveryCount>1,t.streamSequence=parseInt(e[7],10),t.deliverySequence=parseInt(e[8],10),t.timestampNanos=parseInt(e[9],10),t.pending=parseInt(e[10],10),t}class Xn{constructor(e){l(this,"msg");l(this,"di");l(this,"didAck");this.msg=e,this.didAck=!1}get subject(){return this.msg.subject}get sid(){return this.msg.sid}get data(){return this.msg.data}get headers(){return this.msg.headers}get info(){return this.di||(this.di=Wn(this.reply)),this.di}get redelivered(){return this.info.redeliveryCount>1}get reply(){return this.msg.reply||""}get seq(){return this.info.streamSequence}doAck(e){this.didAck||(this.didAck=!this.isWIP(e),this.msg.respond(e))}isWIP(e){return e.length===4&&e[0]===Qe[0]&&e[1]===Qe[1]&&e[2]===Qe[2]&&e[3]===Qe[3]}async ackAck(){if(!this.didAck&&(this.didAck=!0,this.msg.reply)){const t=this.msg.publisher,i=new ji(t.muxSubscriptions);t.request(i);try{t.publish(this.msg.reply,Ks,{reply:`${t.muxSubscriptions.baseInbox}${i.token}`})}catch(n){i.cancel(n)}try{return await Promise.race([i.timer,i.deferred]),!0}catch(n){i.cancel(n)}}return!1}ack(){this.doAck(Ks)}nak(e){let t=Kn;e&&(t=jn().encode(`-NAK ${JSON.stringify({delay:te(e)})}`)),this.doAck(t)}working(){this.doAck(Qe)}next(e,t){let i=Js;if(t){const r=Ti().encode(t);i=At.concat(Js,Vn,r)}const n=e?{reply:e}:void 0;this.msg.respond(i,n)}term(){this.doAck(Jn)}}function De(s,e,t=!1){if(t===!0&&!s)throw p.errorForCode(g.ApiError,new Error(`${e} is not a function`));if(s&&typeof s!="function")throw p.errorForCode(g.ApiError,new Error(`${e} is not a function`))}class Yn extends be{constructor(t,i,n){super();l(this,"sub");l(this,"adapter");l(this,"subIterDone");De(n.adapter,"adapter",!0),this.adapter=n.adapter,n.callback&&De(n.callback,"callback"),this.noIterator=typeof n.callback=="function",n.ingestionFilterFn&&(De(n.ingestionFilterFn,"ingestionFilterFn"),this.ingestionFilterFn=n.ingestionFilterFn),n.protocolFilterFn&&(De(n.protocolFilterFn,"protocolFilterFn"),this.protocolFilterFn=n.protocolFilterFn),n.dispatchedFn&&(De(n.dispatchedFn,"dispatchedFn"),this.dispatchedFn=n.dispatchedFn),n.cleanupFn&&De(n.cleanupFn,"cleanupFn");let r=(_,w)=>{this.callback(_,w)};if(n.callback){const _=n.callback;r=(w,v)=>{const[O,E]=this.adapter(w,v);if(O){_(O,null);return}const{ingest:q}=this.ingestionFilterFn?this.ingestionFilterFn(E,this):{ingest:!0};q&&(this.protocolFilterFn?this.protocolFilterFn(E):!0)&&(_(O,E),this.dispatchedFn&&E&&this.dispatchedFn(E))}}const{max:o,queue:c,timeout:u}=n,h={queue:c,timeout:u,callback:r};o&&o>0&&(h.max=o),this.sub=t.subscribe(i,h),n.cleanupFn&&(this.sub.cleanupFn=n.cleanupFn),this.noIterator||this.iterClosed.then(()=>{this.unsubscribe()}),this.subIterDone=z(),Promise.all([this.sub.closed,this.iterClosed]).then(()=>{this.subIterDone.resolve()}).catch(()=>{this.subIterDone.resolve()}),(async _=>{await _.closed,this.stop()})(this.sub).then().catch()}unsubscribe(t){this.sub.unsubscribe(t)}drain(){return this.sub.drain()}isDraining(){return this.sub.isDraining()}isClosed(){return this.sub.isClosed()}callback(t,i){this.sub.cancelTimeout();const[n,r]=this.adapter(t,i);n&&this.stop(n),r&&this.push(r)}getSubject(){return this.sub.getSubject()}getReceived(){return this.sub.getReceived()}getProcessed(){return this.sub.getProcessed()}getPending(){return this.sub.getPending()}getID(){return this.sub.getID()}getMax(){return this.sub.getMax()}get closed(){return this.sub.closed}}function Ui(s){if(s&&s.headers){const e=s.headers;if(e.hasError){if(e.code===503)return p.errorForCode(g.NoResponders);{let t=e.description;return t===""&&(t=g.RequestError),t=t.toLowerCase(),new p(t,e.status)}}}return null}class Qn{constructor(e,t,i){l(this,"_headers");l(this,"_msg");l(this,"_rdata");l(this,"_reply");l(this,"_subject");l(this,"publisher");this._msg=e,this._rdata=t,this.publisher=i}get subject(){return this._subject?this._subject:(this._subject=fe.decode(this._msg.subject),this._subject)}get reply(){return this._reply?this._reply:(this._reply=fe.decode(this._msg.reply),this._reply)}get sid(){return this._msg.sid}get headers(){if(this._msg.hdr>-1&&!this._headers){const e=this._rdata.subarray(0,this._msg.hdr);this._headers=We.decode(e)}return this._headers}get data(){return this._rdata?this._msg.hdr>-1?this._rdata.subarray(this._msg.hdr):this._rdata:new Uint8Array(0)}respond(e=pe,t){return this.reply?(this.publisher.publish(this.reply,e,t),!0):!1}}let se;function Zn(s){se=s}function Bi(){return se!==void 0&&se.defaultPort!==void 0?se.defaultPort:4222}function Gt(){return se!==void 0&&se.urlParseFn?se.urlParseFn:void 0}function $n(){if(!se||typeof se.factory!="function")throw new Error("transport fn is not set");return se.factory()}function xi(){return se!==void 0&&se.dnsResolveFn?se.dnsResolveFn:void 0}const er=4,Di=48,tr=65,sr=97;function ir(s,e,t,i){const n=new Uint8Array(16);return[0,0,0,0,0,0,0,0,0,0,255,255].forEach((o,c)=>{n[c]=o}),n[12]=s,n[13]=e,n[14]=t,n[15]=i,n}function Qt(s){return nr(s)!==void 0}function nr(s){for(let e=0;e<s.length;e++)switch(s[e]){case".":return Gi(s);case":":return rr(s)}}function Gi(s){const e=new Uint8Array(4);for(let t=0;t<4;t++){if(s.length===0)return;if(t>0){if(s[0]!==".")return;s=s.substring(1)}const{n:i,c:n,ok:r}=or(s);if(!r||i>255)return;s=s.substring(n),e[t]=i}return ir(e[0],e[1],e[2],e[3])}function rr(s){const e=new Uint8Array(16);let t=-1;if(s.length>=2&&s[0]===":"&&s[1]===":"&&(t=0,s=s.substring(2),s.length===0))return e;let i=0;for(;i<16;){const{n,c:r,ok:o}=cr(s);if(!o||n>65535)return;if(r<s.length&&s[r]==="."){if(t<0&&i!=16-4||i+4>16)return;const c=Gi(s);if(c===void 0)return;e[i]=c[12],e[i+1]=c[13],e[i+2]=c[14],e[i+3]=c[15],s="",i+=er;break}if(e[i]=n>>8,e[i+1]=n,i+=2,s=s.substring(r),s.length===0)break;if(s[0]!==":"||s.length==1)return;if(s=s.substring(1),s[0]===":"){if(t>=0)return;if(t=i,s=s.substring(1),s.length===0)break}}if(s.length===0){if(i<16){if(t<0)return;const n=16-i;for(let r=i-1;r>=t;r--)e[r+n]=e[r];for(let r=t+n-1;r>=t;r--)e[r]=0}else if(t>=0)return;return e}}function or(s){let e=0,t=0;for(e=0;e<s.length&&48<=s.charCodeAt(e)&&s.charCodeAt(e)<=57;e++)if(t=t*10+(s.charCodeAt(e)-Di),t>=16777215)return{n:16777215,c:e,ok:!1};return e===0?{n:0,c:0,ok:!1}:{n:t,c:e,ok:!0}}function cr(s){let e=0,t=0;for(t=0;t<s.length;t++){if(48<=s.charCodeAt(t)&&s.charCodeAt(t)<=57)e*=16,e+=s.charCodeAt(t)-Di;else if(97<=s.charCodeAt(t)&&s.charCodeAt(t)<=102)e*=16,e+=s.charCodeAt(t)-sr+10;else if(65<=s.charCodeAt(t)&&s.charCodeAt(t)<=70)e*=16,e+=s.charCodeAt(t)-tr+10;else break;if(e>=16777215)return{n:0,c:t,ok:!1}}return t===0?{n:0,c:t,ok:!1}:{n:e,c:t,ok:!0}}function ar(s){return s.indexOf(".")!==-1?!0:s.indexOf("[")!==-1||s.indexOf("::")!==-1?!1:s.split(":").length<=2}function Zt(s){return!ar(s)}function lr(s){s=s.trim(),s.match(/^(.*:\/\/)(.*)/m)&&(s=s.replace(/^(.*:\/\/)(.*)/gm,"$2")),Zt(s)&&s.indexOf("[")===-1&&(s=`[${s}]`);const e=Zt(s)?s.match(/(]:)(\d+)/):s.match(/(:)(\d+)/),t=e&&e.length===3&&e[1]&&e[2]?parseInt(e[2]):4222,i=t===80?"https":"http",n=new URL(`${i}://${s}`);n.port=`${t}`;let r=n.hostname;return r.charAt(0)==="["&&(r=r.substring(1,r.length-1)),{listen:n.host,hostname:r,port:t}}class $e{constructor(e,t=!1){l(this,"src");l(this,"listen");l(this,"hostname");l(this,"port");l(this,"didConnect");l(this,"reconnects");l(this,"lastConnect");l(this,"gossiped");l(this,"tlsName");l(this,"resolves");this.src=e,this.tlsName="";const i=lr(e);this.listen=i.listen,this.hostname=i.hostname,this.port=i.port,this.didConnect=!1,this.reconnects=0,this.lastConnect=0,this.gossiped=t}toString(){return this.listen}async resolve(e){if(!e.fn)return[this];const t=[];if(Qt(this.hostname))return[this];{const i=await e.fn(this.hostname);for(let n of i){const r=this.port===80?"https":"http",o=new URL(`${r}://${Zt(n)?"["+n+"]":n}`);o.port=`${this.port}`;const c=new $e(o.host,!1);c.tlsName=this.hostname,t.push(c)}}return e.randomize&&Mi(t),this.resolves=t,t}}class ur{constructor(e=[],t={}){l(this,"firstSelect");l(this,"servers");l(this,"currentServer");l(this,"tlsName");l(this,"randomize");this.firstSelect=!0,this.servers=[],this.tlsName="",this.randomize=t.randomize||!1;const i=Gt();e&&(e.forEach(n=>{n=i?i(n):n,this.servers.push(new $e(n))}),this.randomize&&(this.servers=Mi(this.servers))),this.servers.length===0&&this.addServer(`${Jt}:${Bi()}`,!1),this.currentServer=this.servers[0]}updateTLSName(){const e=this.getCurrentServer();Qt(e.hostname)||(this.tlsName=e.hostname,this.servers.forEach(t=>{t.gossiped&&(t.tlsName=this.tlsName)}))}getCurrentServer(){return this.currentServer}addServer(e,t=!1){const i=Gt();e=i?i(e):e;const n=new $e(e,t);Qt(n.hostname)&&(n.tlsName=this.tlsName),this.servers.push(n)}selectServer(){if(this.firstSelect)return this.firstSelect=!1,this.currentServer;const e=this.servers.shift();return e&&(this.servers.push(e),this.currentServer=e),e}removeCurrentServer(){this.removeServer(this.currentServer)}removeServer(e){if(e){const t=this.servers.indexOf(e);this.servers.splice(t,1)}}length(){return this.servers.length}next(){return this.servers.length?this.servers[0]:void 0}getServers(){return this.servers}update(e){const t=[];let i=[];const n=Gt(),r=new Map;e.connect_urls&&e.connect_urls.length>0&&e.connect_urls.forEach(c=>{c=n?n(c):c;const u=new $e(c,!0);r.set(c,u)});const o=[];return this.servers.forEach((c,u)=>{const h=c.listen;c.gossiped&&this.currentServer.listen!==h&&r.get(h)===void 0&&o.push(u),r.delete(h)}),o.reverse(),o.forEach(c=>{const u=this.servers.splice(c,1);i=i.concat(u[0].listen)}),r.forEach((c,u)=>{this.servers.push(c),t.push(u)}),{added:t,deleted:i}}}class zi extends be{constructor(t,i,n={}){super();l(this,"sid");l(this,"queue");l(this,"draining");l(this,"max");l(this,"subject");l(this,"drained");l(this,"protocol");l(this,"timer");l(this,"info");l(this,"cleanupFn");l(this,"closed");rt(this,n),this.protocol=t,this.subject=i,this.draining=!1,this.noIterator=typeof n.callback=="function",this.closed=z(),n.timeout&&(this.timer=Ct(n.timeout),this.timer.then(()=>{this.timer=void 0}).catch(r=>{this.stop(r),this.noIterator&&this.callback(r,{})})),this.noIterator||this.iterClosed.then(()=>{this.unsubscribe()})}setPrePostHandlers(t){if(this.noIterator){const i=this.callback,n=t.ingestionFilterFn?t.ingestionFilterFn:()=>({ingest:!0,protocol:!1}),r=t.protocolFilterFn?t.protocolFilterFn:()=>!0,o=t.dispatchedFn?t.dispatchedFn:()=>{};this.callback=(c,u)=>{const{ingest:h}=n(u);!h||r(u)&&(i(c,u),o(u))}}else this.protocolFilterFn=t.protocolFilterFn,this.dispatchedFn=t.dispatchedFn}callback(t,i){this.cancelTimeout(),t?this.stop(t):this.push(i)}close(){if(!this.isClosed()){if(this.cancelTimeout(),this.stop(),this.cleanupFn)try{this.cleanupFn(this,this.info)}catch{}this.closed.resolve()}}unsubscribe(t){this.protocol.unsubscribe(this,t)}cancelTimeout(){this.timer&&(this.timer.cancel(),this.timer=void 0)}drain(){if(this.protocol.isClosed())throw p.errorForCode(g.ConnectionClosed);if(this.isClosed())throw p.errorForCode(g.SubClosed);return this.drained||(this.protocol.unsub(this),this.drained=this.protocol.flush(z()),this.drained.then(()=>{this.protocol.subscriptions.cancel(this)})),this.drained}isDraining(){return this.draining}isClosed(){return this.done}getSubject(){return this.subject}getMax(){return this.max}getID(){return this.sid}}class hr{constructor(){l(this,"mux");l(this,"subs");l(this,"sidCounter");this.sidCounter=0,this.subs=new Map}size(){return this.subs.size}add(e){return this.sidCounter++,e.sid=this.sidCounter,this.subs.set(e.sid,e),e}setMux(e){return this.mux=e,e}getMux(){return this.mux}get(e){return this.subs.get(e)}resub(e){return this.sidCounter++,this.subs.delete(e.sid),e.sid=this.sidCounter,this.subs.set(e.sid,e),e}all(){const e=[];for(const t of this.subs.values())e.push(t);return e}cancel(e){e&&(e.close(),this.subs.delete(e.sid))}handleError(e){let t=!1;if(e){const n=/^'Permissions Violation for Subscription to "(\S+)"'/i.exec(e.message);if(n){const r=n[1];this.subs.forEach(o=>{r==o.subject&&(o.callback(e,{}),o.close(),t=o!==this.mux)})}}return t}close(){this.subs.forEach(e=>{e.close()})}}class fr{constructor(e,t,i){l(this,"ph");l(this,"interval");l(this,"maxOut");l(this,"timer");l(this,"pendings");this.ph=e,this.interval=t,this.maxOut=i,this.pendings=[]}start(){this.cancel(),this._schedule()}cancel(e){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this._reset(),e&&this.ph.disconnect()}_schedule(){this.timer=setTimeout(()=>{if(this.ph.dispatchStatus({type:et.PingTimer,data:`${this.pendings.length+1}`}),this.pendings.length===this.maxOut){this.cancel(!0);return}const e=z();this.ph.flush(e).then(()=>{this._reset()}).catch(()=>{this.cancel()}),this.pendings.push(e),this._schedule()},this.interval)}_reset(){this.pendings=this.pendings.filter(e=>(e.resolve(),!1))}}class dr extends Error{constructor(e){super(e),this.name="AssertionError"}}function mr(s,e="Assertion failed."){if(!s)throw new dr(e)}const Vs=32*1024,zt=2**32-2;function _t(s,e,t=0){const i=e.byteLength-t;return s.byteLength>i&&(s=s.subarray(0,i)),e.set(s,t),s.byteLength}class Ht{constructor(e){l(this,"_buf");l(this,"_off");if(this._off=0,e==null){this._buf=new Uint8Array(0);return}this._buf=new Uint8Array(e)}bytes(e={copy:!0}){return e.copy===!1?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(e){if(e===0){this.reset();return}if(e<0||e>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+e)}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(e){const t=this._buf.byteLength;return e<=this.capacity-t?(this._reslice(t+e),t):-1}_reslice(e){mr(e<=this._buf.buffer.byteLength),this._buf=new Uint8Array(this._buf.buffer,0,e)}readByte(){const e=new Uint8Array(1);return this.read(e)?e[0]:null}read(e){if(this.empty())return this.reset(),e.byteLength===0?0:null;const t=_t(this._buf.subarray(this._off),e);return this._off+=t,t}writeByte(e){return this.write(Uint8Array.of(e))}writeString(e){return this.write(Xe.encode(e))}write(e){const t=this._grow(e.byteLength);return _t(e,this._buf,t)}_grow(e){const t=this.length;t===0&&this._off!==0&&this.reset();const i=this._tryGrowByReslice(e);if(i>=0)return i;const n=this.capacity;if(e<=Math.floor(n/2)-t)_t(this._buf.subarray(this._off),this._buf);else{if(n+e>zt)throw new Error("The buffer cannot be grown beyond the maximum size.");{const r=new Uint8Array(Math.min(2*n+e,zt));_t(this._buf.subarray(this._off),r),this._buf=r}}return this._off=0,this._reslice(Math.min(t+e,zt)),t}grow(e){if(e<0)throw Error("Buffer._grow: negative count");const t=this._grow(e);this._reslice(t)}readFrom(e){let t=0;const i=new Uint8Array(Vs);for(;;){const n=this.capacity-this.length<Vs,r=n?i:new Uint8Array(this._buf.buffer,this.length),o=e.read(r);if(o===null)return t;n?this.write(r.subarray(0,o)):this._reslice(this.length+o),t+=o}}}var W;(function(s){s[s.OK=0]="OK",s[s.ERR=1]="ERR",s[s.MSG=2]="MSG",s[s.INFO=3]="INFO",s[s.PING=4]="PING",s[s.PONG=5]="PONG"})(W||(W={}));function Ws(){const s={};return s.sid=-1,s.hdr=-1,s.size=-1,s}const gr=48;class Xs{constructor(e){l(this,"dispatcher");l(this,"state");l(this,"as");l(this,"drop");l(this,"hdr");l(this,"ma");l(this,"argBuf");l(this,"msgBuf");this.dispatcher=e,this.state=f.OP_START,this.as=0,this.drop=0,this.hdr=0}parse(e){let t;for(t=0;t<e.length;t++){const i=e[t];switch(this.state){case f.OP_START:switch(i){case d.M:case d.m:this.state=f.OP_M,this.hdr=-1,this.ma=Ws();break;case d.H:case d.h:this.state=f.OP_H,this.hdr=0,this.ma=Ws();break;case d.P:case d.p:this.state=f.OP_P;break;case d.PLUS:this.state=f.OP_PLUS;break;case d.MINUS:this.state=f.OP_MINUS;break;case d.I:case d.i:this.state=f.OP_I;break;default:throw this.fail(e.subarray(t))}break;case f.OP_H:switch(i){case d.M:case d.m:this.state=f.OP_M;break;default:throw this.fail(e.subarray(t))}break;case f.OP_M:switch(i){case d.S:case d.s:this.state=f.OP_MS;break;default:throw this.fail(e.subarray(t))}break;case f.OP_MS:switch(i){case d.G:case d.g:this.state=f.OP_MSG;break;default:throw this.fail(e.subarray(t))}break;case f.OP_MSG:switch(i){case d.SPACE:case d.TAB:this.state=f.OP_MSG_SPC;break;default:throw this.fail(e.subarray(t))}break;case f.OP_MSG_SPC:switch(i){case d.SPACE:case d.TAB:continue;default:this.state=f.MSG_ARG,this.as=t}break;case f.MSG_ARG:switch(i){case d.CR:this.drop=1;break;case d.NL:{const n=this.argBuf?this.argBuf.bytes():e.subarray(this.as,t-this.drop);this.processMsgArgs(n),this.drop=0,this.as=t+1,this.state=f.MSG_PAYLOAD,t=this.as+this.ma.size-1;break}default:this.argBuf&&this.argBuf.writeByte(i)}break;case f.MSG_PAYLOAD:if(this.msgBuf)if(this.msgBuf.length>=this.ma.size){const n=this.msgBuf.bytes({copy:!1});this.dispatcher.push({kind:W.MSG,msg:this.ma,data:n}),this.argBuf=void 0,this.msgBuf=void 0,this.state=f.MSG_END}else{let n=this.ma.size-this.msgBuf.length;const r=e.length-t;r<n&&(n=r),n>0?(this.msgBuf.write(e.subarray(t,t+n)),t=t+n-1):this.msgBuf.writeByte(i)}else t-this.as>=this.ma.size&&(this.dispatcher.push({kind:W.MSG,msg:this.ma,data:e.subarray(this.as,t)}),this.argBuf=void 0,this.msgBuf=void 0,this.state=f.MSG_END);break;case f.MSG_END:switch(i){case d.NL:this.drop=0,this.as=t+1,this.state=f.OP_START;break;default:continue}break;case f.OP_PLUS:switch(i){case d.O:case d.o:this.state=f.OP_PLUS_O;break;default:throw this.fail(e.subarray(t))}break;case f.OP_PLUS_O:switch(i){case d.K:case d.k:this.state=f.OP_PLUS_OK;break;default:throw this.fail(e.subarray(t))}break;case f.OP_PLUS_OK:switch(i){case d.NL:this.dispatcher.push({kind:W.OK}),this.drop=0,this.state=f.OP_START;break}break;case f.OP_MINUS:switch(i){case d.E:case d.e:this.state=f.OP_MINUS_E;break;default:throw this.fail(e.subarray(t))}break;case f.OP_MINUS_E:switch(i){case d.R:case d.r:this.state=f.OP_MINUS_ER;break;default:throw this.fail(e.subarray(t))}break;case f.OP_MINUS_ER:switch(i){case d.R:case d.r:this.state=f.OP_MINUS_ERR;break;default:throw this.fail(e.subarray(t))}break;case f.OP_MINUS_ERR:switch(i){case d.SPACE:case d.TAB:this.state=f.OP_MINUS_ERR_SPC;break;default:throw this.fail(e.subarray(t))}break;case f.OP_MINUS_ERR_SPC:switch(i){case d.SPACE:case d.TAB:continue;default:this.state=f.MINUS_ERR_ARG,this.as=t}break;case f.MINUS_ERR_ARG:switch(i){case d.CR:this.drop=1;break;case d.NL:{let n;this.argBuf?(n=this.argBuf.bytes(),this.argBuf=void 0):n=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:W.ERR,data:n}),this.drop=0,this.as=t+1,this.state=f.OP_START;break}default:this.argBuf&&this.argBuf.write(Uint8Array.of(i))}break;case f.OP_P:switch(i){case d.I:case d.i:this.state=f.OP_PI;break;case d.O:case d.o:this.state=f.OP_PO;break;default:throw this.fail(e.subarray(t))}break;case f.OP_PO:switch(i){case d.N:case d.n:this.state=f.OP_PON;break;default:throw this.fail(e.subarray(t))}break;case f.OP_PON:switch(i){case d.G:case d.g:this.state=f.OP_PONG;break;default:throw this.fail(e.subarray(t))}break;case f.OP_PONG:switch(i){case d.NL:this.dispatcher.push({kind:W.PONG}),this.drop=0,this.state=f.OP_START;break}break;case f.OP_PI:switch(i){case d.N:case d.n:this.state=f.OP_PIN;break;default:throw this.fail(e.subarray(t))}break;case f.OP_PIN:switch(i){case d.G:case d.g:this.state=f.OP_PING;break;default:throw this.fail(e.subarray(t))}break;case f.OP_PING:switch(i){case d.NL:this.dispatcher.push({kind:W.PING}),this.drop=0,this.state=f.OP_START;break}break;case f.OP_I:switch(i){case d.N:case d.n:this.state=f.OP_IN;break;default:throw this.fail(e.subarray(t))}break;case f.OP_IN:switch(i){case d.F:case d.f:this.state=f.OP_INF;break;default:throw this.fail(e.subarray(t))}break;case f.OP_INF:switch(i){case d.O:case d.o:this.state=f.OP_INFO;break;default:throw this.fail(e.subarray(t))}break;case f.OP_INFO:switch(i){case d.SPACE:case d.TAB:this.state=f.OP_INFO_SPC;break;default:throw this.fail(e.subarray(t))}break;case f.OP_INFO_SPC:switch(i){case d.SPACE:case d.TAB:continue;default:this.state=f.INFO_ARG,this.as=t}break;case f.INFO_ARG:switch(i){case d.CR:this.drop=1;break;case d.NL:{let n;this.argBuf?(n=this.argBuf.bytes(),this.argBuf=void 0):n=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:W.INFO,data:n}),this.drop=0,this.as=t+1,this.state=f.OP_START;break}default:this.argBuf&&this.argBuf.writeByte(i)}break;default:throw this.fail(e.subarray(t))}}(this.state===f.MSG_ARG||this.state===f.MINUS_ERR_ARG||this.state===f.INFO_ARG)&&!this.argBuf&&(this.argBuf=new Ht(e.subarray(this.as,t-this.drop))),this.state===f.MSG_PAYLOAD&&!this.msgBuf&&(this.argBuf||this.cloneMsgArg(),this.msgBuf=new Ht(e.subarray(this.as)))}cloneMsgArg(){const e=this.ma.subject.length,t=this.ma.reply?this.ma.reply.length:0,i=new Uint8Array(e+t);i.set(this.ma.subject),this.ma.reply&&i.set(this.ma.reply,e),this.argBuf=new Ht(i),this.ma.subject=i.subarray(0,e),this.ma.reply&&(this.ma.reply=i.subarray(e))}processMsgArgs(e){if(this.hdr>=0)return this.processHeaderMsgArgs(e);const t=[];let i=-1;for(let n=0;n<e.length;n++)switch(e[n]){case d.SPACE:case d.TAB:case d.CR:case d.NL:i>=0&&(t.push(e.subarray(i,n)),i=-1);break;default:i<0&&(i=n)}switch(i>=0&&t.push(e.subarray(i)),t.length){case 3:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.size=this.protoParseInt(t[2]);break;case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.size=this.protoParseInt(t[3]);break;default:throw this.fail(e,"processMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processMsgArgs Bad or Missing Sid Error");if(this.ma.size<0)throw this.fail(e,"processMsgArgs Bad or Missing Size Error")}fail(e,t=""){return t?t=`${t} [${this.state}]`:t=`parse error [${this.state}]`,new Error(`${t}: ${fe.decode(e)}`)}processHeaderMsgArgs(e){const t=[];let i=-1;for(let n=0;n<e.length;n++)switch(e[n]){case d.SPACE:case d.TAB:case d.CR:case d.NL:i>=0&&(t.push(e.subarray(i,n)),i=-1);break;default:i<0&&(i=n)}switch(i>=0&&t.push(e.subarray(i)),t.length){case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.hdr=this.protoParseInt(t[2]),this.ma.size=this.protoParseInt(t[3]);break;case 5:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.hdr=this.protoParseInt(t[3]),this.ma.size=this.protoParseInt(t[4]);break;default:throw this.fail(e,"processHeaderMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Sid Error");if(this.ma.hdr<0||this.ma.hdr>this.ma.size)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Header Size Error");if(this.ma.size<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Size Error")}protoParseInt(e){if(e.length===0)return-1;let t=0;for(let i=0;i<e.length;i++){if(e[i]<48||e[i]>57)return-1;t=t*10+(e[i]-gr)}return t}}var f;(function(s){s[s.OP_START=0]="OP_START",s[s.OP_PLUS=1]="OP_PLUS",s[s.OP_PLUS_O=2]="OP_PLUS_O",s[s.OP_PLUS_OK=3]="OP_PLUS_OK",s[s.OP_MINUS=4]="OP_MINUS",s[s.OP_MINUS_E=5]="OP_MINUS_E",s[s.OP_MINUS_ER=6]="OP_MINUS_ER",s[s.OP_MINUS_ERR=7]="OP_MINUS_ERR",s[s.OP_MINUS_ERR_SPC=8]="OP_MINUS_ERR_SPC",s[s.MINUS_ERR_ARG=9]="MINUS_ERR_ARG",s[s.OP_M=10]="OP_M",s[s.OP_MS=11]="OP_MS",s[s.OP_MSG=12]="OP_MSG",s[s.OP_MSG_SPC=13]="OP_MSG_SPC",s[s.MSG_ARG=14]="MSG_ARG",s[s.MSG_PAYLOAD=15]="MSG_PAYLOAD",s[s.MSG_END=16]="MSG_END",s[s.OP_H=17]="OP_H",s[s.OP_P=18]="OP_P",s[s.OP_PI=19]="OP_PI",s[s.OP_PIN=20]="OP_PIN",s[s.OP_PING=21]="OP_PING",s[s.OP_PO=22]="OP_PO",s[s.OP_PON=23]="OP_PON",s[s.OP_PONG=24]="OP_PONG",s[s.OP_I=25]="OP_I",s[s.OP_IN=26]="OP_IN",s[s.OP_INF=27]="OP_INF",s[s.OP_INFO=28]="OP_INFO",s[s.OP_INFO_SPC=29]="OP_INFO_SPC",s[s.INFO_ARG=30]="INFO_ARG"})(f||(f={}));var d;(function(s){s[s.CR="\r".charCodeAt(0)]="CR",s[s.E="E".charCodeAt(0)]="E",s[s.e="e".charCodeAt(0)]="e",s[s.F="F".charCodeAt(0)]="F",s[s.f="f".charCodeAt(0)]="f",s[s.G="G".charCodeAt(0)]="G",s[s.g="g".charCodeAt(0)]="g",s[s.H="H".charCodeAt(0)]="H",s[s.h="h".charCodeAt(0)]="h",s[s.I="I".charCodeAt(0)]="I",s[s.i="i".charCodeAt(0)]="i",s[s.K="K".charCodeAt(0)]="K",s[s.k="k".charCodeAt(0)]="k",s[s.M="M".charCodeAt(0)]="M",s[s.m="m".charCodeAt(0)]="m",s[s.MINUS="-".charCodeAt(0)]="MINUS",s[s.N="N".charCodeAt(0)]="N",s[s.n="n".charCodeAt(0)]="n",s[s.NL=`
`.charCodeAt(0)]="NL",s[s.O="O".charCodeAt(0)]="O",s[s.o="o".charCodeAt(0)]="o",s[s.P="P".charCodeAt(0)]="P",s[s.p="p".charCodeAt(0)]="p",s[s.PLUS="+".charCodeAt(0)]="PLUS",s[s.R="R".charCodeAt(0)]="R",s[s.r="r".charCodeAt(0)]="r",s[s.S="S".charCodeAt(0)]="S",s[s.s="s".charCodeAt(0)]="s",s[s.SPACE=" ".charCodeAt(0)]="SPACE",s[s.TAB="	".charCodeAt(0)]="TAB"})(d||(d={}));const _r=1024*32,br=/^INFO\s+([^\r\n]+)\r\n/i;function Me(s=""){if(s=s||"_INBOX",typeof s!="string")throw new Error("prefix must be a string");return`${s}.${Li.next()}`}class pr{constructor(){l(this,"baseInbox");l(this,"reqs");this.reqs=new Map}size(){return this.reqs.size}init(e){return this.baseInbox=`${Me(e)}.`,this.baseInbox}add(e){isNaN(e.received)||(e.received=0),this.reqs.set(e.token,e)}get(e){return this.reqs.get(e)}cancel(e){this.reqs.delete(e.token)}getToken(e){const t=e.subject||"";return t.indexOf(this.baseInbox)===0?t.substring(this.baseInbox.length):null}dispatcher(){return(e,t)=>{const i=this.getToken(t);if(i){const n=this.get(i);n&&(e===null&&t.headers&&(e=Ui(t)),n.resolver(e,t))}}}close(){const e=p.errorForCode(g.Timeout);this.reqs.forEach(t=>{t.resolver(e,{})})}}const wr=Ze(`PONG\r
`),Ys=Ze(`PING\r
`);class yr{constructor(e,t,i){l(this,"echo");l(this,"no_responders");l(this,"protocol");l(this,"verbose");l(this,"pedantic");l(this,"jwt");l(this,"nkey");l(this,"sig");l(this,"user");l(this,"pass");l(this,"auth_token");l(this,"tls_required");l(this,"name");l(this,"lang");l(this,"version");l(this,"headers");this.protocol=1,this.version=e.version,this.lang=e.lang,this.echo=t.noEcho?!1:void 0,this.verbose=t.verbose,this.pedantic=t.pedantic,this.tls_required=t.tls?!0:void 0,this.name=t.name;const n=(t&&t.authenticator?t.authenticator(i):{})||{};rt(this,n)}}class Pt{constructor(e,t){l(this,"connected");l(this,"connectedOnce");l(this,"infoReceived");l(this,"info");l(this,"muxSubscriptions");l(this,"options");l(this,"outbound");l(this,"pongs");l(this,"subscriptions");l(this,"transport");l(this,"noMorePublishing");l(this,"connectError");l(this,"publisher");l(this,"_closed");l(this,"closed");l(this,"listeners");l(this,"heartbeats");l(this,"parser");l(this,"outMsgs");l(this,"inMsgs");l(this,"outBytes");l(this,"inBytes");l(this,"pendingLimit");l(this,"lastError");l(this,"abortReconnect");l(this,"servers");l(this,"server");this._closed=!1,this.connected=!1,this.connectedOnce=!1,this.infoReceived=!1,this.noMorePublishing=!1,this.abortReconnect=!1,this.listeners=[],this.pendingLimit=_r,this.outMsgs=0,this.inMsgs=0,this.outBytes=0,this.inBytes=0,this.options=e,this.publisher=t,this.subscriptions=new hr,this.muxSubscriptions=new pr,this.outbound=new At,this.pongs=[],this.pendingLimit=e.pendingLimit||this.pendingLimit;const i=typeof e.servers=="string"?[e.servers]:e.servers;this.servers=new ur(i,{randomize:!e.noRandomize}),this.closed=z(),this.parser=new Xs(this),this.heartbeats=new fr(this,this.options.pingInterval||Ai,this.options.maxPingOut||Pn)}resetOutbound(){this.outbound.reset();const e=this.pongs;this.pongs=[],e.forEach(t=>{t.reject(p.errorForCode(g.Disconnect))}),this.parser=new Xs(this),this.infoReceived=!1}dispatchStatus(e){this.listeners.forEach(t=>{t.push(e)})}status(){const e=new be;return this.listeners.push(e),e}prepare(){this.info=void 0,this.resetOutbound();const e=z();return this.pongs.unshift(e),this.connectError=t=>{e.reject(t)},this.transport=$n(),this.transport.closed().then(async t=>{if(this.connected=!1,!this.isClosed()){await this.disconnected(this.transport.closeError);return}}),e}disconnect(){this.dispatchStatus({type:et.StaleConnection,data:""}),this.transport.disconnect()}async disconnected(e){this.dispatchStatus({type:Ce.Disconnect,data:this.servers.getCurrentServer().toString()}),this.options.reconnect?await this.dialLoop().then(()=>{this.dispatchStatus({type:Ce.Reconnect,data:this.servers.getCurrentServer().toString()})}).catch(t=>{this._close(t)}):await this._close()}async dial(e){const t=this.prepare();let i;try{i=Ct(this.options.timeout||2e4);const n=this.transport.connect(e,this.options);await Promise.race([n,i]),(async()=>{try{for await(const r of this.transport)this.parser.parse(r)}catch(r){console.log("reader closed",r)}})().then()}catch(n){t.reject(n)}try{await Promise.race([i,t]),i&&i.cancel(),this.connected=!0,this.connectError=void 0,this.sendSubscriptions(),this.connectedOnce=!0,this.server.didConnect=!0,this.server.reconnects=0,this.flushPending(),this.heartbeats.start()}catch(n){throw i&&i.cancel(),await this.transport.close(n),n}}async _doDial(e){const t=await e.resolve({fn:xi(),randomize:!this.options.noRandomize});let i=null;for(const n of t)try{i=null,this.dispatchStatus({type:et.Reconnecting,data:n.toString()}),await this.dial(n);return}catch(r){i=r}throw i}async dialLoop(){let e;for(;;){const t=this.options.reconnectDelayHandler?this.options.reconnectDelayHandler():Oi;let i=t;const n=this.selectServer();if(!n||this.abortReconnect)throw e||p.errorForCode(g.ConnectionRefused);const r=Date.now();if(n.lastConnect===0||n.lastConnect+t<=r){n.lastConnect=Date.now();try{await this._doDial(n);break}catch(o){if(e=o,!this.connectedOnce){if(this.options.waitOnFirstConnect)continue;this.servers.removeCurrentServer()}n.reconnects++;const c=this.options.maxReconnectAttempts||0;c!==-1&&n.reconnects>=c&&this.servers.removeCurrentServer()}}else i=Math.min(i,n.lastConnect+t-r),await Fi(i)}}static async connect(e,t){const i=new Pt(e,t);return await i.dialLoop(),i}static toError(e){const t=e?e.toLowerCase():"";return t.indexOf("permissions violation")!==-1?new p(e,g.PermissionsViolation):t.indexOf("authorization violation")!==-1?new p(e,g.AuthorizationViolation):t.indexOf("user authentication expired")!==-1?new p(e,g.AuthenticationExpired):new p(e,g.ProtocolError)}processMsg(e,t){if(this.inMsgs++,this.inBytes+=t.length,!this.subscriptions.sidCounter)return;const i=this.subscriptions.get(e.sid);!i||(i.received+=1,i.callback&&i.callback(null,new Qn(e,t,this)),i.max!==void 0&&i.received>=i.max&&i.unsubscribe())}async processError(e){const t=Bs(e),i=Pt.toError(t);this.subscriptions.handleError(i)||this.dispatchStatus({type:Ce.Error,data:i.code}),await this.handleError(i)}async handleError(e){e.isAuthError()&&this.handleAuthError(e),(e.isPermissionError()||e.isProtocolError())&&await this._close(e),this.lastError=e}handleAuthError(e){this.lastError&&e.code===this.lastError.code&&(this.abortReconnect=!0),this.connectError?this.connectError(e):this.disconnect()}processPing(){this.transport.send(wr)}processPong(){const e=this.pongs.shift();e&&e.resolve()}processInfo(e){const t=JSON.parse(Bs(e));this.info=t;const i=this.options&&this.options.ignoreClusterUpdates?void 0:this.servers.update(t);if(!this.infoReceived){this.infoReceived=!0,this.transport.isEncrypted()&&this.servers.updateTLSName();const{version:r,lang:o}=this.transport;try{const c=new yr({version:r,lang:o},this.options,t.nonce);t.headers&&(c.headers=!0,c.no_responders=!0);const u=JSON.stringify(c);this.transport.send(Ze(`CONNECT ${u}${Ae}`)),this.transport.send(Ys)}catch(c){this._close(p.errorForCode(g.BadAuthentication,c))}}i&&this.dispatchStatus({type:Ce.Update,data:i}),(t.ldm!==void 0?t.ldm:!1)&&this.dispatchStatus({type:Ce.LDM,data:this.servers.getCurrentServer().toString()})}push(e){switch(e.kind){case W.MSG:{const{msg:t,data:i}=e;this.processMsg(t,i);break}case W.OK:break;case W.ERR:this.processError(e.data);break;case W.PING:this.processPing();break;case W.PONG:this.processPong();break;case W.INFO:this.processInfo(e.data);break}}sendCommand(e,...t){const i=this.outbound.length();let n;typeof e=="string"?n=Ze(e):n=e,this.outbound.fill(n,...t),i===0?setTimeout(()=>{this.flushPending()}):this.outbound.size()>=this.pendingLimit&&this.flushPending()}publish(e,t,i){let n=t.length;i=i||{},i.reply=i.reply||"";let r=pe,o=0;if(i.headers){if(this.info&&!this.info.headers)throw new p("headers",g.ServerOptionNotAvailable);r=i.headers.encode(),o=r.length,n=t.length+o}if(this.info&&n>this.info.max_payload)throw p.errorForCode(g.MaxPayloadExceeded);this.outBytes+=n,this.outMsgs++;let c;i.headers?(i.reply?c=`HPUB ${e} ${i.reply} ${o} ${n}${Ae}`:c=`HPUB ${e} ${o} ${n}\r
`,this.sendCommand(c,r,t,St)):(i.reply?c=`PUB ${e} ${i.reply} ${n}\r
`:c=`PUB ${e} ${n}\r
`,this.sendCommand(c,t,St))}request(e){return this.initMux(),this.muxSubscriptions.add(e),e}subscribe(e){return this.subscriptions.add(e),this._subunsub(e),e}_sub(e){e.queue?this.sendCommand(`SUB ${e.subject} ${e.queue} ${e.sid}\r
`):this.sendCommand(`SUB ${e.subject} ${e.sid}\r
`)}_subunsub(e){return this._sub(e),e.max&&this.unsubscribe(e,e.max),e}unsubscribe(e,t){this.unsub(e,t),(e.max===void 0||e.received>=e.max)&&this.subscriptions.cancel(e)}unsub(e,t){!e||this.isClosed()||(t?this.sendCommand(`UNSUB ${e.sid} ${t}${Ae}`):this.sendCommand(`UNSUB ${e.sid}${Ae}`),e.max=t)}resub(e,t){!e||this.isClosed()||(e.subject=t,this.subscriptions.resub(e),this._sub(e))}flush(e){return e||(e=z()),this.pongs.push(e),this.sendCommand(Ys),e}sendSubscriptions(){const e=[];this.subscriptions.all().forEach(t=>{const i=t;i.queue?e.push(`SUB ${i.subject} ${i.queue} ${i.sid}${Ae}`):e.push(`SUB ${i.subject} ${i.sid}${Ae}`)}),e.length&&this.transport.send(Ze(e.join("")))}async _close(e){this._closed||(this.heartbeats.cancel(),this.connectError&&(this.connectError(e),this.connectError=void 0),this.muxSubscriptions.close(),this.subscriptions.close(),this.listeners.forEach(t=>{t.stop()}),this._closed=!0,await this.transport.close(e),await this.closed.resolve(e))}close(){return this._close()}isClosed(){return this._closed}drain(){const e=this.subscriptions.all(),t=[];return e.forEach(i=>{t.push(i.drain())}),Promise.all(t).then(async()=>(this.noMorePublishing=!0,await this.flush(),this.close())).catch(()=>{})}flushPending(){if(!(!this.infoReceived||!this.connected)&&this.outbound.size()){const e=this.outbound.drain();this.transport.send(e)}}initMux(){if(!this.subscriptions.getMux()){const t=this.muxSubscriptions.init(this.options.inboxPrefix),i=new zi(this,`${t}*`);i.callback=this.muxSubscriptions.dispatcher(),this.subscriptions.setMux(i),this.subscribe(i)}}selectServer(){const e=this.servers.selectServer();if(e!==void 0)return this.server=e,this.server}getServer(){return this.server}}function He(s){return new kr(s)}class kr{constructor(e){l(this,"config");l(this,"ordered");l(this,"mack");l(this,"stream");l(this,"callbackFn");l(this,"max");l(this,"qname");l(this,"isBind");this.stream="",this.mack=!1,this.ordered=!1,this.config=Cn("",e||{})}getOpts(){const e={};return e.config=this.config,e.mack=this.mack,e.stream=this.stream,e.callbackFn=this.callbackFn,e.max=this.max,e.queue=this.qname,e.ordered=this.ordered,e.config.ack_policy=e.ordered?D.None:e.config.ack_policy,e.isBind=e.isBind||!1,e}description(e){this.config.description=e}deliverTo(e){this.config.deliver_subject=e}durable(e){ze(e),this.config.durable_name=e}startSequence(e){if(e<=0)throw new Error("sequence must be greater than 0");this.config.deliver_policy=ee.StartSequence,this.config.opt_start_seq=e}startTime(e){this.config.deliver_policy=ee.StartTime,this.config.opt_start_time=e.toISOString()}deliverAll(){this.config.deliver_policy=ee.All}deliverLastPerSubject(){this.config.deliver_policy=ee.LastPerSubject}deliverLast(){this.config.deliver_policy=ee.Last}deliverNew(){this.config.deliver_policy=ee.New}startAtTimeDelta(e){this.startTime(new Date(Date.now()-e))}headersOnly(){this.config.headers_only=!0}ackNone(){this.config.ack_policy=D.None}ackAll(){this.config.ack_policy=D.All}ackExplicit(){this.config.ack_policy=D.Explicit}ackWait(e){this.config.ack_wait=te(e)}maxDeliver(e){this.config.max_deliver=e}filterSubject(e){this.config.filter_subject=e}replayInstantly(){this.config.replay_policy=Ve.Instant}replayOriginal(){this.config.replay_policy=Ve.Original}sample(e){if(e=Math.trunc(e),e<0||e>100)throw new Error("value must be between 0-100");this.config.sample_freq=`${e}%`}limit(e){this.config.rate_limit_bps=e}maxWaiting(e){this.config.max_waiting=e}maxAckPending(e){this.config.max_ack_pending=e}idleHeartbeat(e){this.config.idle_heartbeat=te(e)}flowControl(){this.config.flow_control=!0}deliverGroup(e){this.queue(e)}manualAck(){this.mack=!0}maxMessages(e){this.max=e}callback(e){this.callbackFn=e}queue(e){this.qname=e,this.config.deliver_group=e}orderedConsumer(){this.ordered=!0}bind(e,t){this.stream=e,this.config.durable_name=t,this.isBind=!0}inactiveEphemeralThreshold(e){this.config.inactive_threshold=te(e)}maxPullBatch(e){this.config.max_batch=e}maxPullRequestExpires(e){this.config.max_expires=te(e)}}function Qs(s){return typeof s.getOpts=="function"}function Sr(s){return new Uint8Array(s)}function Ir(s){return new Float64Array(s)}const vr=[],ts=[],Kt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(let s=0,e=Kt.length;s<e;++s)vr[s]=Kt[s],ts[Kt.charCodeAt(s)]=s;ts["-".charCodeAt(0)]=62;ts["_".charCodeAt(0)]=63;new TextEncoder().encode("0123456789abcdef");new TextEncoder;new TextDecoder;function Se(s){const e=Ir(16);if(s)for(let t=0;t<s.length;t++)e[t]=s[t];return e}const Pr=Sr(32);Pr[0]=9;Se();Se([1]);Se([56129,1]);Se([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]);Se([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]);Se([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]);Se([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]);Se([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);var Ot;(function(s){s[s.Key=32]="Key",s[s.Nonce=24]="Nonce",s[s.Overhead=16]="Overhead",s[s.Zero=32]="Zero"})(Ot||(Ot={}));var Ee,Zs;(function(s){s[s.PublicKey=32]="PublicKey",s[s.SecretKey=32]="SecretKey",s[s.SharedKey=32]="SharedKey",s[s.Nonce=Ot.Nonce]="Nonce",s[s.Overhead=Ot.Overhead]="Overhead"})(Ee||(Ee={}));(function(s){s[s.Scalar=32]="Scalar",s[s.GroupElement=32]="GroupElement"})(Zs||(Zs={}));var $s;(function(s){s[s.Hash=64]="Hash"})($s||($s={}));var ei;(function(s){s[s.PublicKey=32]="PublicKey",s[s.SecretKey=64]="SecretKey",s[s.Seed=32]="Seed",s[s.Signature=64]="Signature"})(ei||(ei={}));var ti;(function(s){s[s.Auth=32]="Auth",s[s.AuthFull=64]="AuthFull",s[s.Key=32]="Key"})(ti||(ti={}));var si;(function(s){s[s.PublicKey=Ee.PublicKey]="PublicKey",s[s.SecretKey=Ee.SecretKey]="SecretKey",s[s.Nonce=Ee.Nonce]="Nonce",s[s.Overhead=Ee.PublicKey+Ee.Overhead]="Overhead"})(si||(si={}));var ii;(function(s){s.InvalidPrefixByte="nkeys: invalid prefix byte",s.InvalidKey="nkeys: invalid key",s.InvalidPublicKey="nkeys: invalid public key",s.InvalidSeedLen="nkeys: invalid seed length",s.InvalidSeed="nkeys: invalid seed",s.InvalidEncoding="nkeys: invalid encoded key",s.InvalidSignature="nkeys: signature verification failed",s.CannotSign="nkeys: cannot sign, no private key available",s.PublicKeyOnly="nkeys: no seed or private key available",s.InvalidChecksum="nkeys: invalid checksum",s.SerializationError="nkeys: serialization error",s.ApiError="nkeys: api error",s.ClearedPair="nkeys: pair is cleared"})(ii||(ii={}));var ni;(function(s){s[s.Seed=144]="Seed",s[s.Private=120]="Private",s[s.Operator=112]="Operator",s[s.Server=104]="Server",s[s.Cluster=16]="Cluster",s[s.Account=0]="Account",s[s.User=160]="User"})(ni||(ni={}));function Or(s){return s.authenticator?s.authenticator:s.token?Er(s.token):s.user?Cr(s.user,s.pass):Ar()}function Ar(){return()=>{}}function Cr(s,e){return()=>({user:s,pass:e})}function Er(s){return()=>({auth_token:s})}class Nr extends Et{constructor(e,t){super(e,t)}async add(e={}){$(e.name);const i=await this._request(`${this.prefix}.STREAM.CREATE.${e.name}`,e);return this._fixInfo(i),i}async delete(e){return $(e),(await this._request(`${this.prefix}.STREAM.DELETE.${e}`)).success}async update(e,t={}){if(typeof e=="object"){const o=e;e=o.name,t=o,console.trace("\x1B[33m >> streams.update(config: StreamConfig) api changed to streams.update(name: string, config: StreamUpdateConfig) - this shim will be removed - update your code.  \x1B[0m")}$(e);const i=t;i.name=e;const r=await this._request(`${this.prefix}.STREAM.UPDATE.${e}`,i);return this._fixInfo(r),r}async info(e,t){$(e);const n=await this._request(`${this.prefix}.STREAM.INFO.${e}`,t);return this._fixInfo(n),n}list(){const e=i=>{const n=i;return n.streams.forEach(r=>{this._fixInfo(r)}),n.streams},t=`${this.prefix}.STREAM.LIST`;return new Ri(t,e,this)}_fixInfo(e){e.config.sealed=e.config.sealed||!1,e.config.deny_delete=e.config.deny_delete||!1,e.config.deny_purge=e.config.deny_purge||!1,e.config.allow_rollup_hdrs=e.config.allow_rollup_hdrs||!1}async purge(e,t){if(t){const{keep:n,seq:r}=t;if(typeof n=="number"&&typeof r=="number")throw new Error("can specify one of keep or seq")}return $(e),await this._request(`${this.prefix}.STREAM.PURGE.${e}`,t)}async deleteMessage(e,t,i=!0){$(e);const n={seq:t};return i||(n.no_erase=!0),(await this._request(`${this.prefix}.STREAM.MSG.DELETE.${e}`,n)).success}async getMessage(e,t){$(e);const n=await this._request(`${this.prefix}.STREAM.MSG.GET.${e}`,t);return new Fr(n)}find(e){return this.findStream(e)}}class Fr{constructor(e){l(this,"subject");l(this,"seq");l(this,"data");l(this,"time");l(this,"header");if(this.subject=e.message.subject,this.seq=e.message.seq,this.time=new Date(e.message.time),this.data=e.message.data?this._parse(e.message.data):pe,e.message.hdrs){const t=this._parse(e.message.hdrs);this.header=We.decode(t)}else this.header=It()}_parse(e){const t=atob(e),i=t.length,n=new Uint8Array(i);for(let r=0;r<i;r++)n[r]=t.charCodeAt(r);return n}}class Mr extends Et{constructor(t,i){super(t,i);l(this,"streams");l(this,"consumers");this.streams=new Nr(t,i),this.consumers=new qi(t,i)}async getAccountInfo(){return await this._request(`${this.prefix}.INFO`)}advisories(){const t=new be;return this.nc.subscribe("$JS.EVENT.ADVISORY.>",{callback:(i,n)=>{if(i)throw i;try{const r=this.parseJsResponse(n),o=r.type.split("."),c=o[o.length-1];t.push({kind:c,data:r})}catch(r){t.stop(r)}}}),t}}function Tr(){return{maxPingOut:2,maxReconnectAttempts:10,noRandomize:!1,pedantic:!1,pingInterval:Ai,reconnect:!0,reconnectJitter:100,reconnectJitterTLS:1e3,reconnectTimeWait:Oi,tls:void 0,verbose:!1,waitOnFirstConnect:!1}}function Rr(s){const e=`${Jt}:${Bi()}`;if(s=s||{servers:[e]},s.servers=s.servers||[],typeof s.servers=="string"&&(s.servers=[s.servers]),s.servers.length>0&&s.port)throw new p("port and servers options are mutually exclusive",g.InvalidOption);s.servers.length===0&&s.port&&(s.servers=[`${Jt}:${s.port}`]),s.servers&&s.servers.length===0&&(s.servers=[e]);const t=rt(Tr(),s);if(s.user&&s.token||s.authenticator&&(s.token||s.user||s.pass))throw p.errorForCode(g.BadAuthentication);if(t.authenticator=Or(t),["reconnectDelayHandler","authenticator"].forEach(i=>{if(t[i]&&typeof t[i]!="function")throw new p(`${i} option should be a function`,g.NotFunction)}),t.reconnectDelayHandler||(t.reconnectDelayHandler=()=>{let i=t.tls?t.reconnectJitterTLS:t.reconnectJitter;return i&&(i++,i=Math.floor(Math.random()*i)),t.reconnectTimeWait+i}),t.inboxPrefix)try{Me(t.inboxPrefix)}catch(i){throw new p(i.message,g.ApiError)}if(t.resolve&&typeof xi()!="function")throw new p("'resolve' is not supported on this client",g.InvalidOption);return t}var Ne;(function(s){s.MsgIdHdr="Nats-Msg-Id",s.ExpectedStreamHdr="Nats-Expected-Stream",s.ExpectedLastSeqHdr="Nats-Expected-Last-Sequence",s.ExpectedLastMsgIdHdr="Nats-Expected-Last-Msg-Id",s.ExpectedLastSubjectSequenceHdr="Nats-Expected-Last-Subject-Sequence"})(Ne||(Ne={}));function qr(){return{key:{encode(s){return s},decode(s){return s}},value:{encode(s){return s},decode(s){return s}}}}function Lr(){return{replicas:1,history:1,timeout:2e3,maxBucketSize:-1,maxValueSize:-1,codec:qr(),storage:Xt.File}}const bt="KV-Operation",jr="KV_",pt="$KV",Ur=/^[-/=.\w]+$/,Br=/^[-/=.>*\w]+$/,xr=/^[-\w]+$/;function Dr(s){if(s.startsWith(".")||s.endsWith(".")||!Ur.test(s))throw new Error(`invalid key: ${s}`)}function Gr(s){if(s.startsWith(".")||s.endsWith(".")||!Br.test(s))throw new Error(`invalid key: ${s}`)}function zr(s){if(s.startsWith(".")||s.endsWith("."))throw new Error(`invalid key: ${s}`);const e=s.split(".");let t=!1;for(let i=0;i<e.length;i++)switch(e[i]){case"*":t=!0;break;case">":if(i!==e.length-1)throw new Error(`invalid key: ${s}`);t=!0;break}return t}function ri(s){if(!xr.test(s))throw new Error(`invalid bucket name: ${s}`)}class ss{constructor(e,t,i){l(this,"jsm");l(this,"js");l(this,"stream");l(this,"bucket");l(this,"codec");l(this,"_prefixLen");l(this,"subjPrefix");l(this,"validateKey",Dr);l(this,"validateSearchKey",Gr);l(this,"hasWildcards",zr);ri(e),this.jsm=t,this.js=i,this.bucket=e,this._prefixLen=0,this.subjPrefix=pt;const r=i.prefix||"$JS.API";r!=="$JS.API"&&(this.subjPrefix=`${r}.${pt}`)}static async create(e,t,i={}){ri(t);const n=i.timeout||2e3,r=e;let o=r.opts||{};o=Object.assign(o,{timeout:n});const c=await r.nc.jetstreamManager(o),u=new ss(t,c,e);return await u.init(i),u}async init(e={}){var n;const t=Object.assign(Lr(),e);this.codec=t.codec;const i={};this.stream=i.name=(n=e.streamName)!=null?n:this.bucketName(),i.subjects=[this.subjectForBucket()],i.retention=Vt.Limits,i.max_msgs_per_subject=t.history,i.max_bytes=t.maxBucketSize,i.max_msg_size=t.maxValueSize,i.storage=t.storage,i.discard=Wt.Old,i.num_replicas=t.replicas,t.ttl&&(i.max_age=te(t.ttl)),i.allow_rollup_hdrs=!0;try{await this.jsm.streams.info(i.name)}catch(r){r.message==="stream not found"&&await this.jsm.streams.add(i)}}bucketName(){var e;return(e=this.stream)!=null?e:`${jr}${this.bucket}`}subjectForBucket(){return`${this.subjPrefix}.${this.bucket}.>`}subjectForKey(e){return`${this.subjPrefix}.${this.bucket}.${e}`}fullKeyName(e){return`${pt}.${this.bucket}.${e}`}get prefixLen(){return this._prefixLen===0&&(this._prefixLen=`${pt}.${this.bucket}.`.length),this._prefixLen}encodeKey(e){const t=[];for(const i of e.split("."))switch(i){case">":case"*":t.push(i);break;default:t.push(this.codec.key.encode(i));break}return t.join(".")}decodeKey(e){const t=[];for(const i of e.split("."))switch(i){case">":case"*":t.push(i);break;default:t.push(this.codec.key.decode(i));break}return t.join(".")}close(){return Promise.resolve()}dataLen(e,t){const i=t&&t.get(Fe.MessageSizeHdr)||"";return i!==""?parseInt(i,10):e.length}smToEntry(e,t){return{bucket:this.bucket,key:e,value:t.data,delta:0,created:t.time,revision:t.seq,operation:t.header.get(bt)||"PUT",length:this.dataLen(t.data,t.header)}}jmToEntry(e,t){var n;const i=this.decodeKey(t.subject.substring(this.prefixLen));return{bucket:this.bucket,key:i,value:t.data,created:new Date(En(t.info.timestampNanos)),revision:t.seq,operation:((n=t.headers)==null?void 0:n.get(bt))||"PUT",delta:t.info.pending,length:this.dataLen(t.data,t.headers)}}create(e,t){return this.put(e,t,{previousSeq:0})}update(e,t,i){if(i<=0)throw new Error("version must be greater than 0");return this.put(e,t,{previousSeq:i})}async put(e,t,i={}){const n=this.encodeKey(e);this.validateKey(n);const r={};if(i.previousSeq!==void 0){const c=It();r.headers=c,c.set("Nats-Expected-Last-Subject-Sequence",`${i.previousSeq}`)}return(await this.js.publish(this.subjectForKey(n),t,r)).seq}async get(e){const t=this.encodeKey(e);this.validateKey(t);try{const i=await this.jsm.streams.getMessage(this.bucketName(),{last_by_subj:this.fullKeyName(t)});return this.smToEntry(e,i)}catch(i){if(i.message==="no message found")return null;throw i}}purge(e){return this._deleteOrPurge(e,"PURGE")}delete(e){return this._deleteOrPurge(e,"DEL")}async _deleteOrPurge(e,t){if(!this.hasWildcards(e))return this._doDeleteOrPurge(e,t);const i=await this.keys(e),n=[];for await(const r of i)n.push(this._doDeleteOrPurge(r,t)),n.length===100&&(await Promise.all(n),n.length=0);n.length>0&&await Promise.all(n)}async _doDeleteOrPurge(e,t){const i=this.encodeKey(e);this.validateKey(i);const n=It();n.set(bt,t),t==="PURGE"&&n.set(Fe.RollupHdr,Fe.RollupValueSubject),await this.js.publish(this.subjectForKey(i),pe,{headers:n})}_buildCC(e,t=!1,i={}){const n=this.encodeKey(e);return this.validateSearchKey(e),Object.assign({deliver_policy:t?ee.All:ee.LastPerSubject,ack_policy:D.None,filter_subject:this.fullKeyName(n),flow_control:!0,idle_heartbeat:te(5*1e3)},i)}remove(e){return this.purge(e)}async history(e={}){var _;const t=(_=e.key)!=null?_:">",i=new be,n=z(),r={};r.headers_only=e.headers_only||!1;const o=this._buildCC(t,!0,r),c=o.filter_subject,u=He(o);u.orderedConsumer(),u.callback((w,v)=>{if(w){i.stop(w);return}if(v){const O=this.jmToEntry(t,v);i.push(O),i.received++,v.info.pending===0&&n.resolve()}});const h=await this.js.subscribe(c,u);return n.then(()=>{h.unsubscribe()}),n.catch(w=>{h.unsubscribe()}),i.iterClosed.then(()=>{h.unsubscribe()}),h.closed.then(()=>{i.stop()}).catch(w=>{i.stop(w)}),this.jsm.streams.getMessage(this.stream,{last_by_subj:c}).catch(()=>{n.resolve()}),i}async watch(e={}){var h;const t=(h=e.key)!=null?h:">",i=new be,n={};n.headers_only=e.headers_only||!1;const r=this._buildCC(t,!1,n),o=r.filter_subject,c=He(r);c.orderedConsumer(),c.callback((_,w)=>{if(_){i.stop(_);return}if(w){const v=this.jmToEntry(t,w);i.push(v),i.received++}});const u=await this.js.subscribe(o,c);return i._data=u,i.iterClosed.then(()=>{u.unsubscribe()}),u.closed.then(()=>{i.stop()}).catch(_=>{i.stop(_)}),i}async keys(e=">"){const t=new be,i=this._buildCC(e,!1,{headers_only:!0}),n=i.filter_subject,r=He(i);r.orderedConsumer();const o=await this.js.subscribe(n,r);return(async()=>{var u;for await(const h of o){const _=(u=h.headers)==null?void 0:u.get(bt);if(_!=="DEL"&&_!=="PURGE"){const w=this.decodeKey(h.subject.substring(this.prefixLen));t.push(w)}h.info.pending===0&&o.unsubscribe()}})().then(()=>{t.stop()}).catch(u=>{t.stop(u)}),o.info.last.num_pending===0&&o.unsubscribe(),t}purgeBucket(e){return this.jsm.streams.purge(this.bucketName(),e)}destroy(){return this.jsm.streams.delete(this.bucketName())}async status(){var n,r;const t=(r=(n=this.js.nc.info)==null?void 0:n.cluster)!=null?r:"",i=await this.jsm.streams.info(this.bucketName());return{bucket:this.bucketName(),values:i.state.messages,history:i.config.max_msgs_per_subject,ttl:i.config.max_age,bucket_location:t,backingStore:i.config.storage}}}class Hr{constructor(e){l(this,"js");this.js=e,Qr(this.js.nc)}kv(e,t={}){return ss.create(this.js,e,t)}}class is extends Et{constructor(t,i){super(t,i);l(this,"api");this.api=new qi(t,i)}get views(){return new Hr(this)}async publish(t,i=pe,n){n=n||{},n.expect=n.expect||{};const r=(n==null?void 0:n.headers)||It();n&&(n.msgID&&r.set(Ne.MsgIdHdr,n.msgID),n.expect.lastMsgID&&r.set(Ne.ExpectedLastMsgIdHdr,n.expect.lastMsgID),n.expect.streamName&&r.set(Ne.ExpectedStreamHdr,n.expect.streamName),n.expect.lastSequence&&r.set(Ne.ExpectedLastSeqHdr,`${n.expect.lastSequence}`),n.expect.lastSubjectSequence&&r.set(Ne.ExpectedLastSubjectSequenceHdr,`${n.expect.lastSubjectSequence}`));const o=n.timeout||this.timeout,c={};o&&(c.timeout=o),n&&(c.headers=r);const u=await this.nc.request(t,i,c),h=this.parseJsResponse(u);if(h.stream==="")throw p.errorForCode(g.JetStreamInvalidAck);return h.duplicate=h.duplicate?h.duplicate:!1,h}async pull(t,i){$(t),ze(i);const n=await this.nc.request(`${this.prefix}.CONSUMER.MSG.NEXT.${t}.${i}`,this.jc.encode({no_wait:!0,batch:1,expires:0}),{noMux:!0,timeout:this.timeout}),r=kt(n);if(r)throw r;return vt(n)}fetch(t,i,n={}){$(t),ze(i);let r=null;const o={};o.batch=n.batch||1,o.no_wait=n.no_wait||!1,o.no_wait&&o.expires&&(o.expires=0);const c=n.expires||0;if(c&&(o.expires=te(c)),c===0&&o.no_wait===!1)throw new Error("expires or no_wait is required");const u=new be,h=o.batch;let _=0;u.dispatchedFn=O=>{if(O){if(_++,r&&O.info.pending===0)return;(u.getPending()===1&&O.info.pending===0||h===_)&&u.stop()}};const w=Me(this.nc.options.inboxPrefix),v=this.nc.subscribe(w,{max:n.batch,callback:(O,E)=>{O===null&&(O=kt(E)),O!==null?(r&&(r.cancel(),r=null),An(O)&&(O.code===g.JetStream404NoMessages||O.code===g.JetStream408RequestTimeout)?u.stop():u.stop(O)):(u.received++,u.push(vt(E)))}});return c&&(r=Ct(c),r.catch(()=>{v.isClosed()||(v.drain(),r=null)})),(async()=>{await v.closed,r!==null&&(r.cancel(),r=null),u.stop()})().catch(),this.nc.publish(`${this.prefix}.CONSUMER.MSG.NEXT.${t}.${i}`,this.jc.encode(o),{reply:w}),u}async pullSubscribe(t,i=He()){const n=await this._processOptions(t,i);if(n.ordered)throw new Error("pull subscribers cannot be be ordered");if(n.attached||(n.config.filter_subject=t),n.config.deliver_subject)throw new Error("consumer info specifies deliver_subject - pull consumers cannot have deliver_subject set");const r=n.config.ack_policy;if(r===D.None||r===D.All)throw new Error("ack policy for pull consumers must be explicit");const o=this._buildTypedSubscriptionOpts(n),c=new Jr(this,n.deliver,o);c.info=n;try{await this._maybeCreateConsumer(n)}catch(u){throw c.unsubscribe(),u}return c}async subscribe(t,i=He()){const n=await this._processOptions(t,i);if(!n.config.deliver_subject)throw new Error("consumer info specifies a pull consumer - deliver_subject is required");const r=this._buildTypedSubscriptionOpts(n),o=new Hi(this,n.deliver,r);o.info=n;try{await this._maybeCreateConsumer(n)}catch(c){throw o.unsubscribe(),c}return o}async _processOptions(t,i=He()){var r,o;const n=Qs(i)?i.getOpts():i;if(n.isBind=Qs(i)?i.isBind:!1,n.flow_control={heartbeat_count:0,fc_count:0,consumer_restarts:0},n.ordered){if(n.ordered_consumer_sequence={stream_seq:0,delivery_seq:0},n.config.ack_policy!==D.NotSet&&n.config.ack_policy!==D.None)throw new p("ordered consumer: ack_policy can only be set to 'none'",g.ApiError);if(n.config.durable_name&&n.config.durable_name.length>0)throw new p("ordered consumer: durable_name cannot be set",g.ApiError);if(n.config.deliver_subject&&n.config.deliver_subject.length>0)throw new p("ordered consumer: deliver_subject cannot be set",g.ApiError);if(n.config.max_deliver!==void 0&&n.config.max_deliver>1)throw new p("ordered consumer: max_deliver cannot be set",g.ApiError);if(n.config.deliver_group&&n.config.deliver_group.length>0)throw new p("ordered consumer: deliver_group cannot be set",g.ApiError);n.config.deliver_subject=Me(this.nc.options.inboxPrefix),n.config.ack_policy=D.None,n.config.max_deliver=1,n.config.flow_control=!0,n.config.idle_heartbeat=n.config.idle_heartbeat||te(5e3),n.config.ack_wait=te(22*60*60*1e3)}if(n.config.ack_policy===D.NotSet&&(n.config.ack_policy=D.All),n.api=this,n.config=n.config||{},n.stream=n.stream?n.stream:await this.findStream(t),n.attached=!1,n.config.durable_name)try{const c=await this.api.info(n.stream,n.config.durable_name);if(c){if(c.config.filter_subject&&c.config.filter_subject!==t)throw new Error("subject does not match consumer");const u=(r=n.config.deliver_group)!=null?r:"",h=(o=c.config.deliver_group)!=null?o:"";if(u!==h)throw h===""?new Error("durable requires no queue group"):new Error(`durable requires queue group '${h}'`);n.last=c,n.config=c.config,n.attached=!0}}catch(c){if(c.code!=="404")throw c}return n.attached||(n.config.filter_subject=t),n.deliver=n.config.deliver_subject||Me(this.nc.options.inboxPrefix),n}_buildTypedSubscriptionOpts(t){const i={};return i.adapter=Vr(t.callbackFn===void 0),i.ingestionFilterFn=is.ingestionFn(t.ordered),i.protocolFilterFn=(n,r=!1)=>{const o=n;return Yt(o.msg)?(r||o.msg.respond(),!1):!0},!t.mack&&t.config.ack_policy!==D.None&&(i.dispatchedFn=Yr),t.callbackFn&&(i.callback=t.callbackFn),i.max=t.max||0,i.queue=t.queue,i}async _maybeCreateConsumer(t){if(t.attached)return;if(t.isBind)throw new Error(`unable to bind - durable consumer ${t.config.durable_name} doesn't exist in ${t.stream}`);t.config=Object.assign({deliver_policy:ee.All,ack_policy:D.Explicit,ack_wait:te(30*1e3),replay_policy:Ve.Instant},t.config);const i=await this.api.add(t.stream,t.config);t.name=i.name,t.config=i.config,t.last=i}static ingestionFn(t){return(i,n)=>{const r=n;if(!i)return{ingest:!1,protocol:!1};const o=i;if(Nn(o.msg)){const u=t?r._checkHbOrderConsumer(o.msg):!0;return t||r.info.flow_control.heartbeat_count++,{ingest:u,protocol:!0}}else if(Yt(o.msg))return r.info.flow_control.fc_count++,{ingest:!0,protocol:!0};return{ingest:t?r._checkOrderedConsumer(i):!0,protocol:!1}}}}class ns{constructor(e){l(this,"options");l(this,"protocol");l(this,"draining");l(this,"listeners");this.draining=!1,this.options=Rr(e),this.listeners=[]}static connect(e={}){return new Promise((t,i)=>{const n=new ns(e);Pt.connect(n.options,n).then(r=>{n.protocol=r,async function(){for await(const o of r.status())n.listeners.forEach(c=>{c.push(o)})}(),t(n)}).catch(r=>{i(r)})})}closed(){return this.protocol.closed}async close(){await this.protocol.close()}_check(e,t,i){if(this.isClosed())throw p.errorForCode(g.ConnectionClosed);if(t&&this.isDraining()||i&&this.protocol.noMorePublishing)throw p.errorForCode(g.ConnectionDraining);if(e=e||"",e.length===0)throw p.errorForCode(g.BadSubject)}publish(e,t=pe,i){if(this._check(e,!1,!0),t&&!Rn(t))throw p.errorForCode(g.BadPayload);this.protocol.publish(e,t,i)}subscribe(e,t={}){this._check(e,!0,!1);const i=new zi(this.protocol,e,t);return this.protocol.subscribe(i),i}_resub(e,t,i){this._check(t,!0,!1);const n=e;n.max=i,i&&(n.max=i+n.received),this.protocol.resub(n,t)}request(e,t=pe,i={timeout:1e3,noMux:!1}){try{this._check(e,!0,!0)}catch(n){return Promise.reject(n)}if(i.timeout=i.timeout||1e3,i.timeout<1)return Promise.reject(new p("timeout",g.InvalidOption));if(!i.noMux&&i.reply)return Promise.reject(new p("reply can only be used with noMux",g.InvalidOption));if(i.noMux){const n=i.reply?i.reply:Me(this.options.inboxPrefix),r=z(),o=new Error;return this.subscribe(n,{max:1,timeout:i.timeout,callback:(c,u)=>{c?(c.code!==g.Timeout&&(c.stack+=`

${o.stack}`),r.reject(c)):(c=Ui(u),c?(c.stack+=`

${o.stack}`,r.reject(c)):r.resolve(u))}}),this.protocol.publish(e,t,{reply:n}),r}else{const n=new ji(this.protocol.muxSubscriptions,i);this.protocol.request(n);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${n.token}`,headers:i.headers})}catch(o){n.cancel(o)}const r=Promise.race([n.timer,n.deferred]);return r.catch(()=>{n.cancel()}),r}}flush(){return this.isClosed()?Promise.reject(p.errorForCode(g.ConnectionClosed)):this.protocol.flush()}drain(){return this.isClosed()?Promise.reject(p.errorForCode(g.ConnectionClosed)):this.isDraining()?Promise.reject(p.errorForCode(g.ConnectionDraining)):(this.draining=!0,this.protocol.drain())}isClosed(){return this.protocol.isClosed()}isDraining(){return this.draining}getServer(){const e=this.protocol.getServer();return e?e.listen:""}status(){const e=new be;return this.listeners.push(e),e}get info(){return this.protocol.isClosed()?void 0:this.protocol.info}stats(){return{inBytes:this.protocol.inBytes,outBytes:this.protocol.outBytes,inMsgs:this.protocol.inMsgs,outMsgs:this.protocol.outMsgs}}async jetstreamManager(e={}){const t=new Mr(this,e);try{await t.getAccountInfo()}catch(i){let n=i;throw n.code===g.NoResponders&&(n.code=g.JetStreamNotEnabled),n}return t}jetstream(e={}){return new is(this,e)}}function Kr(s,e){const{proto:t,tls_required:i}=s;if((t===void 0||t<1)&&e.noEcho)throw new p("noEcho",g.ServerOptionNotAvailable);if(e.tls&&!i)throw new p("tls",g.ServerOptionNotAvailable)}class Hi extends Yn{constructor(t,i,n){super(t.nc,i,n);l(this,"js");this.js=t}set info(t){this.sub.info=t}get info(){return this.sub.info}_resetOrderedConsumer(t){if(this.info===null||this.sub.isClosed())return;const i=Me(this.js.nc.options.inboxPrefix);this.js.nc._resub(this.sub,i);const r=this.info;r.ordered_consumer_sequence.delivery_seq=0,r.flow_control.heartbeat_count=0,r.flow_control.fc_count=0,r.flow_control.consumer_restarts++,r.deliver=i,r.config.deliver_subject=i,r.config.deliver_policy=ee.StartSequence,r.config.opt_start_seq=t;const o=`${r.api.prefix}.CONSUMER.CREATE.${r.stream}`;this.js._request(o,this.info.config).catch(c=>{const u=new p(`unable to recreate ordered consumer ${r.stream} at seq ${t}`,g.RequestError,c);this.sub.callback(u,{})})}_checkHbOrderConsumer(t){const i=t.headers.get(Fe.ConsumerStalledHdr);i!==""&&this.js.nc.publish(i);const n=parseInt(t.headers.get(Fe.LastConsumerSeqHdr),10),r=this.info.ordered_consumer_sequence;return this.info.flow_control.heartbeat_count++,n!==r.delivery_seq&&this._resetOrderedConsumer(r.stream_seq+1),!1}_checkOrderedConsumer(t){const i=this.info.ordered_consumer_sequence,n=t.info.streamSequence,r=t.info.deliverySequence;return r!=i.delivery_seq+1?(this._resetOrderedConsumer(i.stream_seq+1),!1):(i.delivery_seq=r,i.stream_seq=n,!0)}async destroy(){this.isClosed()||await this.drain();const t=this.sub.info,i=t.config.durable_name||t.name,n=`${t.api.prefix}.CONSUMER.DELETE.${t.stream}.${i}`;await t.api._request(n)}async consumerInfo(){const t=this.sub.info,i=t.config.durable_name||t.name,n=`${t.api.prefix}.CONSUMER.INFO.${t.stream}.${i}`,r=await t.api._request(n);return t.last=r,r}}class Jr extends Hi{constructor(e,t,i){super(e,t,i)}pull(e={batch:1}){var c;const{stream:t,config:i,name:n}=this.sub.info,r=(c=i.durable_name)!=null?c:n,o={};if(o.batch=e.batch||1,o.no_wait=e.no_wait||!1,e.expires&&e.expires>0&&(o.expires=te(e.expires)),this.info){const u=this.info.api,h=`${u.prefix}.CONSUMER.MSG.NEXT.${t}.${r}`,_=this.sub.subject;u.nc.publish(h,u.jc.encode(o),{reply:_})}}}function Vr(s){return s?Xr:Wr}function Wr(s,e){return s?[s,null]:(s=kt(e),s?[s,null]:[null,vt(e)])}function Xr(s,e){if(s)return[s,null];const t=kt(e);if(t!==null)switch(t.code){case g.JetStream404NoMessages:case g.JetStream408RequestTimeout:case g.JetStream409MaxAckPendingExceeded:return[null,null];default:return[t,null]}return[null,vt(e)]}function Yr(s){s&&s.ack()}const Qr=(()=>{let s=!1;return e=>{var t;if(!s){s=!0;const{lang:i}=(t=e==null?void 0:e.protocol)==null?void 0:t.transport;console.log(i?`\x1B[33m >> jetstream's materialized views functionality in ${i} is beta functionality \x1B[0m`:"\x1B[33m >> jetstream's materialized views functionality is beta functionality \x1B[0m")}}})(),Zr="1.7.2",$r="nats.ws";class eo{constructor(){l(this,"version");l(this,"lang");l(this,"closeError");l(this,"connected");l(this,"done");l(this,"socket");l(this,"options");l(this,"socketClosed");l(this,"encrypted");l(this,"peeked");l(this,"yields");l(this,"signal");l(this,"closedNotification");this.version=Zr,this.lang=$r,this.connected=!1,this.done=!1,this.socketClosed=!1,this.encrypted=!1,this.peeked=!1,this.yields=[],this.signal=z(),this.closedNotification=z()}connect(e,t){const i=z();if(t.tls)return i.reject(new p("tls",g.InvalidOption)),i;this.options=t;const n=e.src;return this.encrypted=n.indexOf("wss://")===0,this.socket=new WebSocket(n),this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{},this.socket.onmessage=r=>{if(this.yields.push(new Uint8Array(r.data)),this.peeked){this.signal.resolve();return}const o=At.concat(...this.yields),c=Ln(o);if(c!==""){const u=br.exec(c);if(!u){t.debug&&console.error("!!!",gt(o)),i.reject(new Error("unexpected response from server"));return}try{const h=JSON.parse(u[1]);Kr(h,this.options),this.peeked=!0,this.connected=!0,this.signal.resolve(),i.resolve()}catch(h){i.reject(h);return}}},this.socket.onclose=r=>{this.socketClosed=!0;let o;this.done||(r.wasClean||(o=new Error(r.reason)),this._closed(o))},this.socket.onerror=r=>{const o=r,c=new p(o.message,g.Unknown,new Error(o.error));i.reject(c)},i}disconnect(){this._closed(void 0,!0)}async _closed(e,t=!0){if(!!this.connected&&!this.done){if(this.closeError=e,!e)for(;!this.socketClosed&&this.socket.bufferedAmount>0;)console.log(this.socket.bufferedAmount),await Fi(100);this.done=!0;try{this.socket.close(e?1002:1e3,e?e.message:void 0)}catch{}t&&this.closedNotification.resolve(e)}}get isClosed(){return this.done}[Symbol.asyncIterator](){return this.iterate()}async*iterate(){for(;;){this.yields.length===0&&await this.signal;const e=this.yields;this.yields=[];for(let t=0;t<e.length;t++)this.options.debug&&console.info(`> ${gt(e[t])}`),yield e[t];if(this.done)break;this.yields.length===0&&(e.length=0,this.yields=e,this.signal=z())}}isEncrypted(){return this.connected&&this.encrypted}send(e){if(this.done)return Promise.resolve();try{return this.socket.send(e.buffer),this.options.debug&&console.info(`< ${gt(e)}`),Promise.resolve()}catch(t){return this.options.debug&&console.error(`!!! ${gt(e)}: ${t}`),Promise.reject(t)}}close(e){return this._closed(e,!1)}closed(){return this.closedNotification}}function to(s){/^(.*:\/\/)(.*)/.test(s)||(s=`https://${s}`);let t=new URL(s);const i=t.protocol.toLowerCase();i!=="https:"&&i!=="http"&&(s=s.replace(/^(.*:\/\/)(.*)/gm,"$2"),t=new URL(`http://${s}`));let n,r;const o=t.hostname,c=t.pathname,u=t.search||"";switch(i){case"http:":case"ws:":case"nats:":r=t.port||"80",n="ws:";break;default:r=t.port||"443",n="wss:";break}return`${n}//${o}:${r}${c}${u}`}function Ao(s={}){return Zn({defaultPort:443,urlParseFn:to,factory:()=>new eo}),ns.connect(s)}const so=s=>({noResultsText:s[0]&2048}),oi=s=>({noResultsText:s[11]}),io=s=>({createText:s[0]&16384}),ci=s=>({createText:s[14]}),no=s=>({loadingText:s[0]&4096}),ai=s=>({loadingText:s[12]});function li(s,e,t){const i=s.slice();return i[116]=e[t],i[118]=t,i}const ro=s=>({item:s[1]&1,label:s[1]&1}),ui=s=>({item:s[116].item,label:s[116].highlighted?s[116].highlighted:s[116].label});function hi(s,e,t){const i=s.slice();return i[119]=e[t],i}const oo=s=>({label:s[0]&2,item:s[0]&2}),fi=s=>({label:s[38](s[119]),item:s[119],unselectItem:s[45]});function di(s,e,t){const i=s.slice();return i[118]=e[t],i}function co(s){let e,t=s[1],i=[];for(let n=0;n<t.length;n+=1)i[n]=mi(di(s,t,n));return{c(){for(let n=0;n<i.length;n+=1)i[n].c();e=B()},l(n){for(let r=0;r<i.length;r+=1)i[r].l(n);e=B()},m(n,r){for(let o=0;o<i.length;o+=1)i[o].m(n,r);F(n,e,r)},p(n,r){if(r[0]&18|r[1]&128){t=n[1];let o;for(o=0;o<t.length;o+=1){const c=di(n,t,o);i[o]?i[o].p(c,r):(i[o]=mi(c),i[o].c(),i[o].m(e.parentNode,e))}for(;o<i.length;o+=1)i[o].d(1);i.length=t.length}},d(n){es(i,n),n&&I(e)}}}function ao(s){let e,t;return{c(){e=K("option"),t=ue(s[3]),this.h()},l(i){e=J(i,"OPTION",{class:!0});var n=X(e);t=he(n,s[3]),n.forEach(I),this.h()},h(){e.__value=s[2],e.value=e.__value,e.selected=!0,P(e,"class","svelte-1nqq7zl")},m(i,n){F(i,e,n),j(e,t)},p(i,n){n[0]&8&&ke(t,i[3]),n[0]&4&&(e.__value=i[2],e.value=e.__value)},d(i){i&&I(e)}}}function mi(s){let e,t=s[38](s[118])+"",i,n,r;return{c(){e=K("option"),i=ue(t),n=ge(),this.h()},l(o){e=J(o,"OPTION",{class:!0});var c=X(e);i=he(c,t),n=_e(c),c.forEach(I),this.h()},h(){e.__value=r=s[4](s[118],!0),e.value=e.__value,e.selected=!0,P(e,"class","svelte-1nqq7zl")},m(o,c){F(o,e,c),j(e,i),j(e,n)},p(o,c){c[0]&2&&t!==(t=o[38](o[118])+"")&&ke(i,t),c[0]&18&&r!==(r=o[4](o[118],!0))&&(e.__value=r,e.value=e.__value)},d(o){o&&I(e)}}}function gi(s){let e,t,i=s[1],n=[];for(let o=0;o<i.length;o+=1)n[o]=_i(hi(s,i,o));const r=o=>G(n[o],1,1,()=>{n[o]=null});return{c(){for(let o=0;o<n.length;o+=1)n[o].c();e=B()},l(o){for(let c=0;c<n.length;c+=1)n[c].l(o);e=B()},m(o,c){for(let u=0;u<n.length;u+=1)n[u].m(o,c);F(o,e,c),t=!0},p(o,c){if(c[0]&2|c[1]&16512|c[2]&1048576){i=o[1];let u;for(u=0;u<i.length;u+=1){const h=hi(o,i,u);n[u]?(n[u].p(h,c),L(n[u],1)):(n[u]=_i(h),n[u].c(),L(n[u],1),n[u].m(e.parentNode,e))}for(Ke(),u=i.length;u<n.length;u+=1)r(u);Je()}},i(o){if(!t){for(let c=0;c<i.length;c+=1)L(n[c]);t=!0}},o(o){n=n.filter(Boolean);for(let c=0;c<n.length;c+=1)G(n[c]);t=!1},d(o){es(n,o),o&&I(e)}}}function lo(s){let e,t,i=s[38](s[119])+"",n,r,o,c,u,h;return{c(){e=K("div"),t=K("span"),n=ue(i),r=ge(),o=K("span"),c=ge(),this.h()},l(_){e=J(_,"DIV",{class:!0});var w=X(e);t=J(w,"SPAN",{class:!0});var v=X(t);n=he(v,i),v.forEach(I),r=_e(w),o=J(w,"SPAN",{class:!0}),X(o).forEach(I),w.forEach(I),c=_e(_),this.h()},h(){P(t,"class","tag svelte-1nqq7zl"),P(o,"class","tag is-delete svelte-1nqq7zl"),P(e,"class","tags has-addons svelte-1nqq7zl")},m(_,w){F(_,e,w),j(e,t),j(t,n),j(e,r),j(e,o),F(_,c,w),u||(h=Z(o,"click",In(function(){vn(s[45](s[119]))&&s[45](s[119]).apply(this,arguments)})),u=!0)},p(_,w){s=_,w[0]&2&&i!==(i=s[38](s[119])+"")&&ke(n,i)},d(_){_&&I(e),_&&I(c),u=!1,h()}}}function _i(s){let e;const t=s[83].tag,i=nt(t,s,s[82],fi),n=i||lo(s);return{c(){n&&n.c()},l(r){n&&n.l(r)},m(r,o){n&&n.m(r,o),e=!0},p(r,o){i?i.p&&(!e||o[0]&2|o[2]&1048576)&&tt(i,t,r,r[82],e?it(t,r[82],o,oo):st(r[82]),fi):n&&n.p&&(!e||o[0]&2)&&n.p(r,e?o:[-1,-1,-1,-1])},i(r){e||(L(n,r),e=!0)},o(r){G(n,r),e=!1},d(r){n&&n.d(r)}}}function bi(s){let e,t,i,n;return{c(){e=K("span"),t=ue("\u2716"),this.h()},l(r){e=J(r,"SPAN",{class:!0});var o=X(e);t=he(o,"\u2716"),o.forEach(I),this.h()},h(){P(e,"class","autocomplete-clear-button svelte-1nqq7zl")},m(r,o){F(r,e,o),j(e,t),i||(n=Z(e,"click",s[49]),i=!0)},p:Sn,d(r){r&&I(e),i=!1,n()}}}function uo(s){let e,t;const i=s[83]["no-results"],n=nt(i,s,s[82],oi),r=n||go(s);return{c(){e=K("div"),r&&r.c(),this.h()},l(o){e=J(o,"DIV",{class:!0});var c=X(e);r&&r.l(c),c.forEach(I),this.h()},h(){P(e,"class","autocomplete-list-item-no-results svelte-1nqq7zl")},m(o,c){F(o,e,c),r&&r.m(e,null),t=!0},p(o,c){n?n.p&&(!t||c[0]&2048|c[2]&1048576)&&tt(n,i,o,o[82],t?it(i,o[82],c,so):st(o[82]),oi):r&&r.p&&(!t||c[0]&2048)&&r.p(o,t?c:[-1,-1,-1,-1])},i(o){t||(L(r,o),t=!0)},o(o){G(r,o),t=!1},d(o){o&&I(e),r&&r.d(o)}}}function ho(s){let e,t,i,n;const r=s[83].create,o=nt(r,s,s[82],ci),c=o||_o(s);return{c(){e=K("div"),c&&c.c(),this.h()},l(u){e=J(u,"DIV",{class:!0});var h=X(e);c&&c.l(h),h.forEach(I),this.h()},h(){P(e,"class","autocomplete-list-item-create svelte-1nqq7zl")},m(u,h){F(u,e,h),c&&c.m(e,null),t=!0,i||(n=Z(e,"click",s[39]),i=!0)},p(u,h){o?o.p&&(!t||h[0]&16384|h[2]&1048576)&&tt(o,r,u,u[82],t?it(r,u[82],h,io):st(u[82]),ci):c&&c.p&&(!t||h[0]&16384)&&c.p(u,t?h:[-1,-1,-1,-1])},i(u){t||(L(c,u),t=!0)},o(u){G(c,u),t=!1},d(u){u&&I(e),c&&c.d(u),i=!1,n()}}}function fo(s){let e,t;const i=s[83].loading,n=nt(i,s,s[82],ai),r=n||bo(s);return{c(){e=K("div"),r&&r.c(),this.h()},l(o){e=J(o,"DIV",{class:!0});var c=X(e);r&&r.l(c),c.forEach(I),this.h()},h(){P(e,"class","autocomplete-list-item-loading svelte-1nqq7zl")},m(o,c){F(o,e,c),r&&r.m(e,null),t=!0},p(o,c){n?n.p&&(!t||c[0]&4096|c[2]&1048576)&&tt(n,i,o,o[82],t?it(i,o[82],c,no):st(o[82]),ai):r&&r.p&&(!t||c[0]&4096)&&r.p(o,t?c:[-1,-1,-1,-1])},i(o){t||(L(r,o),t=!0)},o(o){G(r,o),t=!1},d(o){o&&I(e),r&&r.d(o)}}}function mo(s){let e,t,i,n=s[31],r=[];for(let u=0;u<n.length;u+=1)r[u]=yi(li(s,n,u));const o=u=>G(r[u],1,1,()=>{r[u]=null});let c=s[5]>0&&s[31].length>s[5]&&ki(s);return{c(){for(let u=0;u<r.length;u+=1)r[u].c();e=ge(),c&&c.c(),t=B()},l(u){for(let h=0;h<r.length;h+=1)r[h].l(u);e=_e(u),c&&c.l(u),t=B()},m(u,h){for(let _=0;_<r.length;_+=1)r[_].m(u,h);F(u,e,h),c&&c.m(u,h),F(u,t,h),i=!0},p(u,h){if(h[0]&1073741856|h[1]&524801|h[2]&1048576){n=u[31];let _;for(_=0;_<n.length;_+=1){const w=li(u,n,_);r[_]?(r[_].p(w,h),L(r[_],1)):(r[_]=yi(w),r[_].c(),L(r[_],1),r[_].m(e.parentNode,e))}for(Ke(),_=n.length;_<r.length;_+=1)o(_);Je()}u[5]>0&&u[31].length>u[5]?c?c.p(u,h):(c=ki(u),c.c(),c.m(t.parentNode,t)):c&&(c.d(1),c=null)},i(u){if(!i){for(let h=0;h<n.length;h+=1)L(r[h]);i=!0}},o(u){r=r.filter(Boolean);for(let h=0;h<r.length;h+=1)G(r[h]);i=!1},d(u){es(r,u),u&&I(e),c&&c.d(u),u&&I(t)}}}function go(s){let e;return{c(){e=ue(s[11])},l(t){e=he(t,s[11])},m(t,i){F(t,e,i)},p(t,i){i[0]&2048&&ke(e,t[11])},d(t){t&&I(e)}}}function _o(s){let e;return{c(){e=ue(s[14])},l(t){e=he(t,s[14])},m(t,i){F(t,e,i)},p(t,i){i[0]&16384&&ke(e,t[14])},d(t){t&&I(e)}}}function bo(s){let e;return{c(){e=ue(s[12])},l(t){e=he(t,s[12])},m(t,i){F(t,e,i)},p(t,i){i[0]&4096&&ke(e,t[12])},d(t){t&&I(e)}}}function pi(s){let e,t,i=s[116]&&wi(s);return{c(){i&&i.c(),e=B()},l(n){i&&i.l(n),e=B()},m(n,r){i&&i.m(n,r),F(n,e,r),t=!0},p(n,r){n[116]?i?(i.p(n,r),r[1]&1&&L(i,1)):(i=wi(n),i.c(),L(i,1),i.m(e.parentNode,e)):i&&(Ke(),G(i,1,1,()=>{i=null}),Je())},i(n){t||(L(i),t=!0)},o(n){G(i),t=!1},d(n){i&&i.d(n),n&&I(e)}}}function wi(s){let e,t,i,n,r;const o=s[83].item,c=nt(o,s,s[82],ui),u=c||yo(s);function h(){return s[86](s[116])}function _(){return s[87](s[118])}return{c(){e=K("div"),u&&u.c(),this.h()},l(w){e=J(w,"DIV",{class:!0});var v=X(e);u&&u.l(v),v.forEach(I),this.h()},h(){P(e,"class",t="autocomplete-list-item "+(s[118]===s[30]?"selected":"")+" svelte-1nqq7zl"),Ge(e,"confirmed",s[50](s[116].item))},m(w,v){F(w,e,v),u&&u.m(e,null),i=!0,n||(r=[Z(e,"click",h),Z(e,"pointerenter",_)],n=!0)},p(w,v){s=w,c?c.p&&(!i||v[1]&1|v[2]&1048576)&&tt(c,o,s,s[82],i?it(o,s[82],v,ro):st(s[82]),ui):u&&u.p&&(!i||v[1]&1)&&u.p(s,i?v:[-1,-1,-1,-1]),(!i||v[0]&1073741824&&t!==(t="autocomplete-list-item "+(s[118]===s[30]?"selected":"")+" svelte-1nqq7zl"))&&P(e,"class",t),v[0]&1073741824|v[1]&524289&&Ge(e,"confirmed",s[50](s[116].item))},i(w){i||(L(u,w),i=!0)},o(w){G(u,w),i=!1},d(w){w&&I(e),u&&u.d(w),n=!1,Ii(r)}}}function po(s){let e,t=s[116].label+"",i;return{c(){e=new vi,i=B(),this.h()},l(n){e=Pi(n),i=B(),this.h()},h(){e.a=i},m(n,r){e.m(t,n,r),F(n,i,r)},p(n,r){r[1]&1&&t!==(t=n[116].label+"")&&e.p(t)},d(n){n&&I(i),n&&e.d()}}}function wo(s){let e,t=s[116].highlighted+"",i;return{c(){e=new vi,i=B(),this.h()},l(n){e=Pi(n),i=B(),this.h()},h(){e.a=i},m(n,r){e.m(t,n,r),F(n,i,r)},p(n,r){r[1]&1&&t!==(t=n[116].highlighted+"")&&e.p(t)},d(n){n&&I(i),n&&e.d()}}}function yo(s){let e;function t(r,o){return r[116].highlighted?wo:po}let i=t(s),n=i(s);return{c(){n.c(),e=B()},l(r){n.l(r),e=B()},m(r,o){n.m(r,o),F(r,e,o)},p(r,o){i===(i=t(r))&&n?n.p(r,o):(n.d(1),n=i(r),n&&(n.c(),n.m(e.parentNode,e)))},d(r){n.d(r),r&&I(e)}}}function yi(s){let e,t,i=s[116]&&(s[5]<=0||s[118]<s[5])&&pi(s);return{c(){i&&i.c(),e=B()},l(n){i&&i.l(n),e=B()},m(n,r){i&&i.m(n,r),F(n,e,r),t=!0},p(n,r){n[116]&&(n[5]<=0||n[118]<n[5])?i?(i.p(n,r),r[0]&32|r[1]&1&&L(i,1)):(i=pi(n),i.c(),L(i,1),i.m(e.parentNode,e)):i&&(Ke(),G(i,1,1,()=>{i=null}),Je())},i(n){t||(L(i),t=!0)},o(n){G(i),t=!1},d(n){i&&i.d(n),n&&I(e)}}}function ki(s){let e,t=s[13]&&Si(s);return{c(){t&&t.c(),e=B()},l(i){t&&t.l(i),e=B()},m(i,n){t&&t.m(i,n),F(i,e,n)},p(i,n){i[13]?t?t.p(i,n):(t=Si(i),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},d(i){t&&t.d(i),i&&I(e)}}}function Si(s){let e,t,i=s[31].length-s[5]+"",n,r,o;return{c(){e=K("div"),t=ue("..."),n=ue(i),r=ge(),o=ue(s[13]),this.h()},l(c){e=J(c,"DIV",{class:!0});var u=X(e);t=he(u,"..."),n=he(u,i),r=_e(u),o=he(u,s[13]),u.forEach(I),this.h()},h(){P(e,"class","autocomplete-list-item-no-results svelte-1nqq7zl")},m(c,u){F(c,e,u),j(e,t),j(e,n),j(e,r),j(e,o)},p(c,u){u[0]&32|u[1]&1&&i!==(i=c[31].length-c[5]+"")&&ke(n,i),u[0]&8192&&ke(o,c[13])},d(c){c&&I(e)}}}function ko(s){let e,t,i,n,r,o,c,u,h,_,w,v,O,E,q,de,we,M,Ie,Te;function Re(m,S){if(!m[6]&&m[2])return ao;if(m[6]&&m[1])return co}let le=Re(s),T=le&&le(s),R=s[6]&&s[1]&&gi(s),N=s[35]&&bi(s);const qe=[mo,fo,ho,uo],V=[];function Le(m,S){return m[31]&&m[31].length>0?0:m[34]&&m[12]?1:m[7]?2:m[11]?3:-1}return~(E=Le(s))&&(q=V[E]=qe[E](s)),{c(){e=K("div"),t=K("select"),T&&T.c(),i=ge(),n=K("div"),R&&R.c(),r=ge(),o=K("input"),w=ge(),N&&N.c(),v=ge(),O=K("div"),q&&q.c(),this.h()},l(m){e=J(m,"DIV",{class:!0});var S=X(e);t=J(S,"SELECT",{name:!0,id:!0,class:!0});var ne=X(t);T&&T.l(ne),ne.forEach(I),i=_e(S),n=J(S,"DIV",{class:!0});var re=X(n);R&&R.l(re),r=_e(re),o=J(re,"INPUT",{type:!0,class:!0,id:!0,autocomplete:!0,placeholder:!0,name:!0,title:!0,tabindex:!0}),w=_e(re),N&&N.l(re),re.forEach(I),v=_e(S),O=J(S,"DIV",{class:!0});var ve=X(O);q&&q.l(ve),ve.forEach(I),S.forEach(I),this.h()},h(){P(t,"name",s[20]),P(t,"id",s[21]),t.multiple=s[6],P(t,"class","svelte-1nqq7zl"),P(o,"type","text"),P(o,"class",c=(s[17]?s[17]:"")+" "+(s[27]?"":"input autocomplete-input")+" svelte-1nqq7zl"),P(o,"id",u=s[18]?s[18]:""),P(o,"autocomplete",h=s[23]?"on":"off"),P(o,"placeholder",s[15]),P(o,"name",s[19]),o.disabled=s[26],o.required=s[28],P(o,"title",s[22]),o.readOnly=_=s[24]||s[8]&&s[1],P(o,"tabindex",s[29]),P(n,"class","input-container svelte-1nqq7zl"),P(O,"class",de=(s[25]?s[25]:"")+" autocomplete-list "+(s[36]?"":"hidden")+" is-fullwidth svelte-1nqq7zl"),P(e,"class",we=(s[16]?s[16]:"")+" "+(s[9]||!s[0].length?"hide-arrow":"")+" "+(s[6]?"is-multiple":"")+" autocomplete select is-fullwidth "+s[37]+" svelte-1nqq7zl"),Ge(e,"show-clear",s[35]),Ge(e,"is-loading",s[10]&&s[34])},m(m,S){F(m,e,S),j(e,t),T&&T.m(t,null),j(e,i),j(e,n),R&&R.m(n,null),j(n,r),j(n,o),s[84](o),Ls(o,s[3]),j(n,w),N&&N.m(n,null),j(e,v),j(e,O),~E&&V[E].m(O,null),s[88](O),M=!0,Ie||(Te=[Z(window,"click",s[41]),Z(o,"input",s[85]),Z(o,"input",s[44]),Z(o,"focus",s[47]),Z(o,"blur",s[48]),Z(o,"keydown",s[42]),Z(o,"click",s[46]),Z(o,"keypress",s[43])],Ie=!0)},p(m,S){le===(le=Re(m))&&T?T.p(m,S):(T&&T.d(1),T=le&&le(m),T&&(T.c(),T.m(t,null))),(!M||S[0]&1048576)&&P(t,"name",m[20]),(!M||S[0]&2097152)&&P(t,"id",m[21]),(!M||S[0]&64)&&(t.multiple=m[6]),m[6]&&m[1]?R?(R.p(m,S),S[0]&66&&L(R,1)):(R=gi(m),R.c(),L(R,1),R.m(n,r)):R&&(Ke(),G(R,1,1,()=>{R=null}),Je()),(!M||S[0]&134348800&&c!==(c=(m[17]?m[17]:"")+" "+(m[27]?"":"input autocomplete-input")+" svelte-1nqq7zl"))&&P(o,"class",c),(!M||S[0]&262144&&u!==(u=m[18]?m[18]:""))&&P(o,"id",u),(!M||S[0]&8388608&&h!==(h=m[23]?"on":"off"))&&P(o,"autocomplete",h),(!M||S[0]&32768)&&P(o,"placeholder",m[15]),(!M||S[0]&524288)&&P(o,"name",m[19]),(!M||S[0]&67108864)&&(o.disabled=m[26]),(!M||S[0]&268435456)&&(o.required=m[28]),(!M||S[0]&4194304)&&P(o,"title",m[22]),(!M||S[0]&16777474&&_!==(_=m[24]||m[8]&&m[1]))&&(o.readOnly=_),(!M||S[0]&536870912)&&P(o,"tabindex",m[29]),S[0]&8&&o.value!==m[3]&&Ls(o,m[3]),m[35]?N?N.p(m,S):(N=bi(m),N.c(),N.m(n,null)):N&&(N.d(1),N=null);let ne=E;E=Le(m),E===ne?~E&&V[E].p(m,S):(q&&(Ke(),G(V[ne],1,1,()=>{V[ne]=null}),Je()),~E?(q=V[E],q?q.p(m,S):(q=V[E]=qe[E](m),q.c()),L(q,1),q.m(O,null)):q=null),(!M||S[0]&33554432|S[1]&32&&de!==(de=(m[25]?m[25]:"")+" autocomplete-list "+(m[36]?"":"hidden")+" is-fullwidth svelte-1nqq7zl"))&&P(O,"class",de),(!M||S[0]&66113&&we!==(we=(m[16]?m[16]:"")+" "+(m[9]||!m[0].length?"hide-arrow":"")+" "+(m[6]?"is-multiple":"")+" autocomplete select is-fullwidth "+m[37]+" svelte-1nqq7zl"))&&P(e,"class",we),S[0]&66113|S[1]&16&&Ge(e,"show-clear",m[35]),S[0]&67137|S[1]&8&&Ge(e,"is-loading",m[10]&&m[34])},i(m){M||(L(R),L(q),M=!0)},o(m){G(R),G(q),M=!1},d(m){m&&I(e),T&&T.d(),R&&R.d(),s[84](null),N&&N.d(),~E&&V[E].d(),s[88](null),Ie=!1,Ii(Te)}}}function So(s,e){if(typeof s!="function"){console.error("Not a function: "+s+", argument: "+e);return}let t;try{t=s(e)}catch{console.warn("Error executing Autocomplete function on value: "+e+" function: "+s)}return t}function wt(s,e){let t=So(s,e);return t==null&&(t=""),typeof t!="string"&&(t=t.toString()),t}function $t(s,e){if(!s)return 0;const t=s.keywords;let i=0;return e.forEach(n=>{t.includes(n)&&i++}),i}function Io(s,e,t){return $t(e,t)-$t(s,t)}function yt(s){return s.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function vo(s,e,t){let i,n,{$$slots:r={},$$scope:o}=e,{items:c=[]}=e,{searchFunction:u=!1}=e,{labelFieldName:h=void 0}=e,{keywordsFieldName:_=h}=e,{valueFieldName:w=void 0}=e,{labelFunction:v=function(a){return a==null?"":h?a[h]:a}}=e,{keywordsFunction:O=function(a){return a==null?"":_?a[_]:v(a)}}=e,{valueFunction:E=function(a,b=!1){return a==null?a:!N||b?w?a[w]:a:a.map(y=>w?y[w]:y)}}=e,{keywordsCleanFunction:q=function(a){return a}}=e,{textCleanFunction:de=function(a){return a}}=e,{beforeChange:we=function(a,b){return!0}}=e,{onChange:M=function(a){}}=e,{onFocus:Ie=function(){}}=e,{onBlur:Te=function(){}}=e,{onCreate:Re=function(a){k&&console.log("onCreate: "+a)}}=e,{selectFirstIfEmpty:le=!1}=e,{minCharactersToSearch:T=1}=e,{maxItemsToShowInList:R=0}=e,{multiple:N=!1}=e,{create:qe=!1}=e,{ignoreAccents:V=!0}=e,{matchAllKeywords:Le=!0}=e,{sortByMatchedKeywords:m=!1}=e,{itemFilterFunction:S=void 0}=e,{itemSortFunction:ne=void 0}=e,{lock:re=!1}=e,{delay:ve=0}=e,{localFiltering:ot=!0}=e,{localSorting:Nt=!0}=e,{cleanUserText:Ft=!0}=e,{closeOnBlur:Mt=!1}=e,{hideArrow:rs=!1}=e,{showClear:Tt=!1}=e,{showLoadingIndicator:os=!1}=e,{noResultsText:cs="No results found"}=e,{loadingText:as="Loading results..."}=e,{moreItemsText:ls="items not shown"}=e,{createText:us="Not found, add anyway?"}=e,{placeholder:hs=void 0}=e,{className:fs=void 0}=e,{inputClassName:ds=void 0}=e,{inputId:je=void 0}=e,{name:ms=void 0}=e,{selectName:gs=void 0}=e,{selectId:_s=void 0}=e,{title:bs=void 0}=e,{html5autocomplete:ps=void 0}=e,{readonly:ws=void 0}=e,{dropdownClassName:ys=void 0}=e,{disabled:ks=!1}=e,{noInputStyles:Ss=!1}=e,{required:Is=null}=e,{debug:k=!1}=e,{tabindex:vs=0}=e,{selectedItem:A=N?[]:void 0}=e,{value:Rt=void 0}=e,{highlightedItem:qt=void 0}=e;const Ps="sautocomplete-"+Math.floor(Math.random()*1e3);let ye,Ue,Pe=!1,ct=!1,U=-1,{text:Y}=e,at=0,x,Q=[],Lt=0,Oe=0,jt;function Ut(a){return wt(v,a)}function Ki(a){const b=wt(O,a);let y=wt(q,b);return y=y.toLowerCase().trim(),V&&(y=yt(y)),k&&console.log("Extracted keywords: '"+y+"' from item: "+JSON.stringify(a)),y}function lt(){let a;k&&(a=`Autocomplete prepare list ${je?`(id: ${je})`:""}`,console.time(a),console.log("Prepare items to search"),console.log("items: "+JSON.stringify(c))),Array.isArray(c)||(console.warn("Autocomplete items / search function did not return array but",c),t(0,c=[]));const b=c?c.length:0;Q=new Array(b),b>0&&c.forEach((y,C)=>{const H=Ji(y);H===void 0&&console.log("Undefined item for: ",y),Q[C]=H}),t(31,x=Q),k&&(console.log(Q.length+" items to search"),console.timeEnd(a))}function Ji(a){return{keywords:ot?Ki(a):[],label:Ut(a),item:a}}function Vi(){t(2,Rt=E(A)),t(3,Y=N?"":Ut(A)),t(31,x=Q),M(A)}function Wi(a){if(a==null)return"";if(!Ft)return a;const b=a.replace(/[&/\\#,+()$~%.'":*?<>{}]/g," ").trim();return wt(de,b).toLowerCase().trim()}async function Os(){let a;k&&(a=`Autocomplete search ${je?`(id: ${je})`:""}`,console.time(a),console.log("Searching user entered text: '"+Y+"'"));let b=Wi(Y);if(T>1&&b.length<T&&(b=""),t(81,at=b.length),k&&console.log("Changed user entered text '"+Y+"' into '"+b+"'"),b===""){u?(t(0,c=[]),k&&console.log("User entered text is empty clear list of items")):(t(31,x=Q),k&&console.log("User entered text is empty set the list of items to all items")),Rs(),k&&console.timeEnd(a);return}if(!u)ut(b);else{Lt=Lt+1;const y=Lt;if(t(34,ct=!0),u.constructor.name==="AsyncGeneratorFunction"){for await(const C of u(b)){if(y<Oe)return!1;y>Oe&&t(0,c=[]),Oe=y,t(0,c=[...c,...C]),ut(b)}Oe<y&&(Oe=y,t(0,c=[]),ut(b))}else{let C=await u(b);if(y<Oe)return!1;Oe=y,t(0,c=C),ut(b)}t(34,ct=!1)}k&&(console.timeEnd(a),console.log("Search found "+x.length+" items"))}function Xi(a,b){const y=$t(a,b);return Le?y>=b.length:y>0}function ut(a){lt();const y=(V?yt(a):a).split(/\s+/g);let C;ot?(S?C=Q.filter(oe=>S(oe.item,y)):C=Q.filter(oe=>Xi(oe,y)),Nt&&(ne?C=C.sort((oe,Ye)=>ne(oe.item,Ye.item,y)):m&&(C=C.sort((oe,Ye)=>Io(oe,Ye,y))))):C=Q;const H=qs(y,"label");return t(31,x=C.map(H)),Rs(),!0}function As(a){let b;if(k&&console.log("createdItem",a),typeof a!="undefined"){lt(),t(31,x=Q);let y=Ms(a,x);y<=0&&(t(0,c=[a]),lt(),t(31,x=Q),y=0),y>=0&&(t(30,U=y),b=x[U])}return b}function Bt(a){if(k&&console.log("selectListItem",a),typeof a=="undefined"&&qe){const y=Re(Y);if(typeof y!="undefined"){if(typeof y.then=="function")return y.then(C=>{if(typeof C!="undefined"){const H=As(C);typeof H!="undefined"&&Bt(H)}}),!0;a=As(y)}}if(typeof a=="undefined")return k&&console.log("listItem is undefined. Can not select."),!1;if(re&&A)return!0;const b=a.item;return we(A,b)&&(N?A?A.includes(b)?t(1,A=A.filter(y=>y!==b)):t(1,A=[...A,b]):t(1,A=[b]):(t(1,A=void 0),t(1,A=b))),!0}function xt(){k&&console.log("selectItem",U);const a=x[U];Bt(a)?(k&&console.log("selectListItem true, closing"),me(),N&&ye.focus()):k&&console.log("selectListItem false, not closing")}function Yi(){k&&console.log("up"),ft(),U>0&&t(30,U--,U),ht()}function Qi(){k&&console.log("down"),ft(),U<x.length-1&&t(30,U++,U),ht()}function ht(){k&&console.log("highlight");const a=".selected";k&&console.log("Seaching DOM element: "+a+" in "+Ue);const b=Ue&&Ue.querySelector(a);b?typeof b.scrollIntoViewIfNeeded=="function"?(k&&console.log("Scrolling selected item into view"),b.scrollIntoViewIfNeeded()):b.scrollIntoView==="function"?(k&&console.log("Scrolling selected item into view"),b.scrollIntoView()):k&&console.warn("Could not scroll selected item into view, scrollIntoViewIfNeeded not supported"):k&&console.warn("Selected item not found to scroll into view")}function Cs(a){k&&console.log("onListItemClick"),Bt(a)&&(me(),N&&ye.focus())}function Zi(a){k&&console.log("onDocumentClick"),a.composedPath().some(b=>b.classList&&b.classList.contains(Ps))?(k&&console.log("onDocumentClick inside"),ht()):(k&&console.log("onDocumentClick outside"),me())}function $i(a){k&&console.log("onKeyDown");let b=a.key;b==="Tab"&&a.shiftKey&&(b="ShiftTab");const C={Tab:Pe?me():null,ShiftTab:Pe?me():null,ArrowDown:Qi.bind(this),ArrowUp:Yi.bind(this),Escape:rn.bind(this),Backspace:N&&A&&A.length&&!Y?on.bind(this):null}[b];typeof C=="function"&&C(a)}function en(a){k&&console.log("onKeyPress"),a.key==="Enter"&&(a.preventDefault(),tn())}function tn(){xt()}function sn(a){k&&console.log("onInput"),t(3,Y=a.target.value),jt&&clearTimeout(jt),ve?jt=setTimeout(Ns,ve):Ns()}function Es(a){k&&console.log("unselectItem",a),t(1,A=A.filter(b=>b!==a)),ye.focus()}function Ns(){Os()&&(t(30,U=0),ft())}function nn(){k&&console.log("onInputClick"),Fs()}function rn(a){k&&console.log("onEsc"),a.stopPropagation(),Pe&&(ye.focus(),me())}function on(a){k&&console.log("onBackspace"),Es(A[A.length-1])}function cn(){k&&console.log("onFocus"),Ie(),Fs()}function an(){k&&console.log("onBlur"),Mt&&me(),Te()}function Fs(){if(k&&console.log("resetListToAllItemsAndOpen"),Y?!Q.length&&A&&u&&Os():t(31,x=Q),ft(),A){k&&console.log("Searching currently selected item: "+JSON.stringify(A));const a=Ms(A,x);a>=0&&(t(30,U=a),ht())}}function Ms(a,b){k&&console.log("Finding index for item",a);let y=-1;for(let C=0;C<b.length;C++){const H=b[C];if(typeof H=="undefined"){k&&console.log(`listItem ${C} is undefined. Skipping.`);continue}if(k&&console.log("Item "+C+": "+JSON.stringify(H)),a===H.item){y=C;break}}return k&&(y>=0?console.log("Found index for item: "+y):console.warn("Not found index for item: "+a)),y}function ft(){k&&console.log("open"),!Ts()&&t(80,Pe=!0)}function me(){k&&console.log("close"),t(80,Pe=!1),t(34,ct=!1),!Y&&le&&(t(30,U=0),xt())}function Ts(){return T>1&&at<T}function Rs(){Ts()&&me()}function ln(){k&&console.log("clear"),t(3,Y=""),t(1,A=N?[]:void 0),setTimeout(()=>{ye.focus(),me()})}function qs(a,b){return y=>{let C=y[b];const H=Object.assign({highlighted:void 0},y);H.highlighted=C;const oe=C.toLowerCase(),Ye=V?yt(oe):oe;if(a&&a.length){const dt=[];for(let Be=0;Be<a.length;Be++){let ce=a[Be];V&&(ce=yt(ce));const xe=ce.length;let ae=0;do if(ae=Ye.indexOf(ce,ae),ae>=0){let mt=ae+xe;dt.push([ae,mt]),ae=mt}while(ae!==-1)}if(dt.length>0){const Be=new Set;for(let ce=0;ce<dt.length;ce++){const xe=dt[ce],ae=xe[0],mt=xe[1],_n=oe.substring(ae,mt);Be.add(_n)}for(let ce of Be){if(ce==="b")continue;const xe=new RegExp("("+ce+")","ig"),ae=H.highlighted.replace(xe,"<b>$1</b>");H.highlighted=ae}}}return H}}function un(a){return A?N?A.includes(a):a===A:!1}function hn(a){js[a?"unshift":"push"](()=>{ye=a,t(32,ye)})}function fn(){Y=this.value,t(3,Y)}const dn=a=>Cs(a),mn=a=>{t(30,U=a)};function gn(a){js[a?"unshift":"push"](()=>{Ue=a,t(33,Ue)})}return s.$$set=a=>{"items"in a&&t(0,c=a.items),"searchFunction"in a&&t(52,u=a.searchFunction),"labelFieldName"in a&&t(53,h=a.labelFieldName),"keywordsFieldName"in a&&t(54,_=a.keywordsFieldName),"valueFieldName"in a&&t(55,w=a.valueFieldName),"labelFunction"in a&&t(56,v=a.labelFunction),"keywordsFunction"in a&&t(57,O=a.keywordsFunction),"valueFunction"in a&&t(4,E=a.valueFunction),"keywordsCleanFunction"in a&&t(58,q=a.keywordsCleanFunction),"textCleanFunction"in a&&t(59,de=a.textCleanFunction),"beforeChange"in a&&t(60,we=a.beforeChange),"onChange"in a&&t(61,M=a.onChange),"onFocus"in a&&t(62,Ie=a.onFocus),"onBlur"in a&&t(63,Te=a.onBlur),"onCreate"in a&&t(64,Re=a.onCreate),"selectFirstIfEmpty"in a&&t(65,le=a.selectFirstIfEmpty),"minCharactersToSearch"in a&&t(66,T=a.minCharactersToSearch),"maxItemsToShowInList"in a&&t(5,R=a.maxItemsToShowInList),"multiple"in a&&t(6,N=a.multiple),"create"in a&&t(7,qe=a.create),"ignoreAccents"in a&&t(67,V=a.ignoreAccents),"matchAllKeywords"in a&&t(68,Le=a.matchAllKeywords),"sortByMatchedKeywords"in a&&t(69,m=a.sortByMatchedKeywords),"itemFilterFunction"in a&&t(70,S=a.itemFilterFunction),"itemSortFunction"in a&&t(71,ne=a.itemSortFunction),"lock"in a&&t(8,re=a.lock),"delay"in a&&t(72,ve=a.delay),"localFiltering"in a&&t(73,ot=a.localFiltering),"localSorting"in a&&t(74,Nt=a.localSorting),"cleanUserText"in a&&t(75,Ft=a.cleanUserText),"closeOnBlur"in a&&t(76,Mt=a.closeOnBlur),"hideArrow"in a&&t(9,rs=a.hideArrow),"showClear"in a&&t(77,Tt=a.showClear),"showLoadingIndicator"in a&&t(10,os=a.showLoadingIndicator),"noResultsText"in a&&t(11,cs=a.noResultsText),"loadingText"in a&&t(12,as=a.loadingText),"moreItemsText"in a&&t(13,ls=a.moreItemsText),"createText"in a&&t(14,us=a.createText),"placeholder"in a&&t(15,hs=a.placeholder),"className"in a&&t(16,fs=a.className),"inputClassName"in a&&t(17,ds=a.inputClassName),"inputId"in a&&t(18,je=a.inputId),"name"in a&&t(19,ms=a.name),"selectName"in a&&t(20,gs=a.selectName),"selectId"in a&&t(21,_s=a.selectId),"title"in a&&t(22,bs=a.title),"html5autocomplete"in a&&t(23,ps=a.html5autocomplete),"readonly"in a&&t(24,ws=a.readonly),"dropdownClassName"in a&&t(25,ys=a.dropdownClassName),"disabled"in a&&t(26,ks=a.disabled),"noInputStyles"in a&&t(27,Ss=a.noInputStyles),"required"in a&&t(28,Is=a.required),"debug"in a&&t(78,k=a.debug),"tabindex"in a&&t(29,vs=a.tabindex),"selectedItem"in a&&t(1,A=a.selectedItem),"value"in a&&t(2,Rt=a.value),"highlightedItem"in a&&t(51,qt=a.highlightedItem),"text"in a&&t(3,Y=a.text),"$$scope"in a&&t(82,o=a.$$scope)},s.$$.update=()=>{s.$$.dirty[0]&1&&lt(),s.$$.dirty[0]&2&&Vi(),s.$$.dirty[0]&1073741824|s.$$.dirty[1]&1&&t(51,qt=x&&U&&U>=0&&U<x.length?x[U].item:null),s.$$.dirty[0]&1|s.$$.dirty[2]&786432&&t(36,i=Pe&&(c&&c.length>0||at>0)),s.$$.dirty[0]&322|s.$$.dirty[2]&32768&&t(35,n=Tt||(re||N)&&A)},[c,A,Rt,Y,E,R,N,qe,re,rs,os,cs,as,ls,us,hs,fs,ds,je,ms,gs,_s,bs,ps,ws,ys,ks,Ss,Is,vs,U,x,ye,Ue,ct,n,i,Ps,Ut,xt,Cs,Zi,$i,en,sn,Es,nn,cn,an,ln,un,qt,u,h,_,w,v,O,q,de,we,M,Ie,Te,Re,le,T,V,Le,m,S,ne,ve,ot,Nt,Ft,Mt,Tt,k,qs,Pe,at,o,r,hn,fn,dn,mn,gn]}class Co extends wn{constructor(e){super(),yn(this,e,vo,ko,kn,{items:0,searchFunction:52,labelFieldName:53,keywordsFieldName:54,valueFieldName:55,labelFunction:56,keywordsFunction:57,valueFunction:4,keywordsCleanFunction:58,textCleanFunction:59,beforeChange:60,onChange:61,onFocus:62,onBlur:63,onCreate:64,selectFirstIfEmpty:65,minCharactersToSearch:66,maxItemsToShowInList:5,multiple:6,create:7,ignoreAccents:67,matchAllKeywords:68,sortByMatchedKeywords:69,itemFilterFunction:70,itemSortFunction:71,lock:8,delay:72,localFiltering:73,localSorting:74,cleanUserText:75,closeOnBlur:76,hideArrow:9,showClear:77,showLoadingIndicator:10,noResultsText:11,loadingText:12,moreItemsText:13,createText:14,placeholder:15,className:16,inputClassName:17,inputId:18,name:19,selectName:20,selectId:21,title:22,html5autocomplete:23,readonly:24,dropdownClassName:25,disabled:26,noInputStyles:27,required:28,debug:78,tabindex:29,selectedItem:1,value:2,highlightedItem:51,text:3,highlightFilter:79},null,[-1,-1,-1,-1])}get highlightFilter(){return this.$$.ctx[79]}}export{pe as E,Ti as J,Co as S,Ao as c};
